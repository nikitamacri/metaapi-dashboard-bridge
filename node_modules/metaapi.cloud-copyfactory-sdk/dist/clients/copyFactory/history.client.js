'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _metaApi = require('../metaApi.client');

var _metaApi2 = _interopRequireDefault(_metaApi);

var _randomstring = require('randomstring');

var _randomstring2 = _interopRequireDefault(_randomstring);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * metaapi.cloud CopyFactory history API (trade copying history API) client (see
 * https://metaapi.cloud/docs/copyfactory/)
 */
class HistoryClient extends _metaApi2.default {

  /**
   * Constructs CopyFactory history API client instance
   * @param {HttpClient} httpClient HTTP client
   * @param {String} token authorization token
   * @param {String} domain domain to connect to, default is agiliumtrade.agiliumtrade.ai
   */
  constructor(httpClient, token, domain = 'agiliumtrade.agiliumtrade.ai') {
    super(httpClient, token, domain);
    this._host = `https://trading-api-v1.${domain}`;
  }

  /**
   * CopyFactory provider or subscriber
   * @typedef {Object} CopyFactorySubscriberOrProvider
   * @property {String} id profile id
   * @property {String} name user name
   * @property {Array<CopyFactoryStrategyIdAndName>} strategies array of strategy IDs provided by provider or subscribed to by
   * subscriber
   */

  /**
   * CopyFactory strategy id and name
   * @typedef {Object} CopyFactoryStrategyIdAndName
   * @property {String} id unique strategy id
   * @property {String} name human-readable strategy name
   */

  /**
   * Returns list of providers providing strategies to the current user
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getProviders/
   * @return {Promise<Array<CopyFactorySubscriberOrProvider>>} promise resolving with providers found
   */
  getProviders() {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getProviders');
    }
    const opts = {
      url: `${this._host}/users/current/providers`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    return this._httpClient.request(opts);
  }

  /**
   * Returns list of subscribers subscribed to the strategies of the current user
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getSubscribers/
   * @return {Promise<Array<CopyFactorySubscriberOrProvider>>} promise resolving with subscribers found
   */
  getSubscribers() {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getSubscribers');
    }
    const opts = {
      url: `${this._host}/users/current/subscribers`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    return this._httpClient.request(opts);
  }

  /**
   * Returns list of strategies the current user is subscribed to
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getStrategiesSubscribed/
   * @return {Promise<Array<CopyFactoyStrategyIdAndName>>} promise resolving with strategies found
   */
  getStrategiesSubscribed() {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getStrategiesSubscribed');
    }
    const opts = {
      url: `${this._host}/users/current/strategies-subscribed`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    return this._httpClient.request(opts);
  }

  /**
   * Returns list of strategies the current user provides to other users
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getProvidedStrategies/
   * @return {Promise<Array<CopyFactoryStrategyIdAndName>>} promise resolving with strategies found
   */
  getProvidedStrategies() {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getProvidedStrategies');
    }
    const opts = {
      url: `${this._host}/users/current/provided-strategies`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    return this._httpClient.request(opts);
  }

  /**
   * CopyFactory transaction
   * @typedef {Object} CopyFactoryTransaction
   * @property {String} id transaction id
   * @property {String} type transaction type (one of DEAL_TYPE_BUY, DEAL_TYPE_SELL, DEAL_TYPE_BALANCE,
   * DEAL_TYPE_CREDIT, DEAL_TYPE_CHARGE, DEAL_TYPE_CORRECTION, DEAL_TYPE_BONUS, DEAL_TYPE_COMMISSION,
   * DEAL_TYPE_COMMISSION_DAILY, DEAL_TYPE_COMMISSION_MONTHLY, DEAL_TYPE_COMMISSION_AGENT_DAILY,
   * DEAL_TYPE_COMMISSION_AGENT_MONTHLY, DEAL_TYPE_INTEREST, DEAL_TYPE_BUY_CANCELED, DEAL_TYPE_SELL_CANCELED,
   * DEAL_DIVIDEND, DEAL_DIVIDEND_FRANKED, DEAL_TAX). See
   * https://www.mql5.com/en/docs/constants/tradingconstants/dealproperties#enum_deal_type
   * @property {Date} time transaction time
   * @property {String} accountId CopyFactory account id
   * @property {String} [symbol] optional symbol traded
   * @property {CopyFactorySubscriberOrProvider} subscriber strategy subscriber
   * @property {Boolean} demo demo account flag
   * @property {CopyFactorySubscriberOrProvider} provider strategy provider
   * @property {CopyFactoryStrategyIdAndName} strategy strategy
   * @property {String} [positionId] source position id
   * @property {Number} improvement high-water mark strategy balance improvement
   * @property {Number} providerCommission provider commission
   * @property {Number} platformCommission platform commission
   * @property {Number} [incomingProviderCommission] commission paid by provider to underlying providers
   * @property {Number} [incomingPlatformCommission] platform commission paid by provider to underlying providers
   * @property {Number} [lotPrice] trade lot price
   * @property {Number} [tickPrice] trade tick price
   * @property {Number} [amount] trade amount
   * @property {Number} [commission] trade commission
   * @property {Number} swap trade swap
   * @property {Number} profit trade profit
   * @property {CopyFactoryTransactionMetrics} [metrics] trade copying metrics such as slippage and latencies. Measured
   * selectively for copied trades
   */

  /**
   * Trade copying metrics such as slippage and latencies
   * @typedef {Object} CopyFactoryTransactionMetrics
   * @property {Number} [tradeCopyingLatency] trade copying latency, measured in milliseconds based on transaction time
   * provided by broker
   * @property {Number} [tradeCopyingSlippageInBasisPoints] trade copying slippage, measured in basis points (0.01
   * percent) based on transaction price provided by broker
   * @property {Number} [tradeCopyingSlippageInAccountCurrency] trade copying slippage, measured in account currency
   * based on transaction price provided by broker
   * @property {Number} [mtAndBrokerSignalLatency] trade signal latency introduced by broker and MT platform, measured
   * in milliseconds
   * @property {Number} [tradeAlgorithmLatency] trade algorithm latency introduced by CopyFactory servers, measured in
   * milliseconds
   * @property {Number} [mtAndBrokerTradeLatency] trade latency for a copied trade introduced by broker and MT platform,
   * measured in milliseconds
   * @property {Number} [totalLatency] total trade copying latency, measured in milliseconds. This value might be
   * slightly different from tradeCopyingLatency value due to limited measurement precision as it is measured based
   * on timestamps captured during copy trading process as opposed to broker data
   */

  /**
   * Returns list of transactions on the strategies the current user provides to other users
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getProvidedStrategiesTransactions/
   * @param {Date} from time to load transactions from
   * @param {Date} till time to load transactions till
   * @param {Array<string>} [strategyIds] optional list of strategy ids to filter transactions by
   * @param {Array<string>} [accountIds] the list of CopyFactory subscriber account id (64-character long) to filter by
   * @param {Array<string>} [subscriberIds] optional list of subscribers to filter transactions by
   * @param {number} [offset] pagination offset. Default value is 0
   * @param {number} [limit] pagination limit. Default value is 1000
   * @return {Promise<Array<CopyFactoryTransaction>>} promise resolving with transactions found
   */
  async getProvidedStrategiesTransactions(from, till, strategyIds, accountIds, subscriberIds, offset, limit) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getProvidedStrategiesTransactions');
    }
    let qs = {
      from,
      till
    };
    if (strategyIds) {
      qs.strategyId = strategyIds;
    }
    if (subscriberIds) {
      qs.subscriberId = subscriberIds;
    }
    if (accountIds) {
      qs.accountId = accountIds;
    }
    if (offset !== undefined) {
      qs.offset = offset;
    }
    if (limit) {
      qs.limit = limit;
    }
    const opts = {
      url: `${this._host}/users/current/provided-strategies/transactions`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      qs,
      json: true
    };
    let transactions = await this._httpClient.request(opts);
    transactions.forEach(t => t.time = new Date(t.time));
    return transactions;
  }

  /**
   * Returns list of trades on the strategies the current user subscribed to
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getStrategiesSubscribedTransactions/
   * @param {Date} from time to load transactions from
   * @param {Date} till time to load transactions till
   * @param {Array<String>} strategyIds optional list of strategy ids to filter transactions by
   * @param {Array<string>} [accountIds] the list of CopyFactory subscriber account id (64-character long) to filter by
   * @param {Array<String>} providerIds optional list of providers to filter transactions by
   * @param {Number} offset pagination offset. Default value is 0
   * @param {Number} limit pagination limit. Default value is 1000
   * @return {Promise<Array<CopyFactoryTransaction>>} promise resolving with transactions found
   */
  async getStrategiesSubscribedTransactions(from, till, strategyIds, accountIds, providerIds, offset, limit) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getStrategiesSubscribedTransactions');
    }
    let qs = {
      from,
      till
    };
    if (strategyIds) {
      qs.strategyId = strategyIds;
    }
    if (providerIds) {
      qs.providerId = providerIds;
    }
    if (accountIds) {
      qs.accountId = accountIds;
    }
    if (offset !== undefined) {
      qs.offset = offset;
    }
    if (limit) {
      qs.limit = limit;
    }
    const opts = {
      url: `${this._host}/users/current/strategies-subscribed/transactions`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      qs,
      json: true
    };
    let transactions = await this._httpClient.request(opts);
    transactions.forEach(t => t.time = new Date(t.time));
    return transactions;
  }

}
exports.default = HistoryClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL2NvcHlGYWN0b3J5L2hpc3RvcnkuY2xpZW50LmVzNiJdLCJuYW1lcyI6WyJIaXN0b3J5Q2xpZW50IiwiTWV0YUFwaUNsaWVudCIsImNvbnN0cnVjdG9yIiwiaHR0cENsaWVudCIsInRva2VuIiwiZG9tYWluIiwiX2hvc3QiLCJnZXRQcm92aWRlcnMiLCJfaXNOb3RKd3RUb2tlbiIsIl9oYW5kbGVOb0FjY2Vzc0Vycm9yIiwib3B0cyIsInVybCIsIm1ldGhvZCIsImhlYWRlcnMiLCJfdG9rZW4iLCJqc29uIiwiX2h0dHBDbGllbnQiLCJyZXF1ZXN0IiwiZ2V0U3Vic2NyaWJlcnMiLCJnZXRTdHJhdGVnaWVzU3Vic2NyaWJlZCIsImdldFByb3ZpZGVkU3RyYXRlZ2llcyIsImdldFByb3ZpZGVkU3RyYXRlZ2llc1RyYW5zYWN0aW9ucyIsImZyb20iLCJ0aWxsIiwic3RyYXRlZ3lJZHMiLCJhY2NvdW50SWRzIiwic3Vic2NyaWJlcklkcyIsIm9mZnNldCIsImxpbWl0IiwicXMiLCJzdHJhdGVneUlkIiwic3Vic2NyaWJlcklkIiwiYWNjb3VudElkIiwidW5kZWZpbmVkIiwidHJhbnNhY3Rpb25zIiwiZm9yRWFjaCIsInQiLCJ0aW1lIiwiRGF0ZSIsImdldFN0cmF0ZWdpZXNTdWJzY3JpYmVkVHJhbnNhY3Rpb25zIiwicHJvdmlkZXJJZHMiLCJwcm92aWRlcklkIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUE7Ozs7QUFDQTs7Ozs7O0FBRUE7Ozs7QUFJZSxNQUFNQSxhQUFOLFNBQTRCQyxpQkFBNUIsQ0FBMEM7O0FBRXZEOzs7Ozs7QUFNQUMsY0FBWUMsVUFBWixFQUF3QkMsS0FBeEIsRUFBK0JDLFNBQVMsOEJBQXhDLEVBQXdFO0FBQ3RFLFVBQU1GLFVBQU4sRUFBa0JDLEtBQWxCLEVBQXlCQyxNQUF6QjtBQUNBLFNBQUtDLEtBQUwsR0FBYywwQkFBeUJELE1BQU8sRUFBOUM7QUFDRDs7QUFFRDs7Ozs7Ozs7O0FBU0E7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QU9YZCxZQUFNO0FBUEssS0FBYjtBQVNBLFFBQUltQixlQUFlLE1BQU0sS0FBS2xCLFdBQUwsQ0FBaUJDLE9BQWpCLENBQXlCUCxJQUF6QixDQUF6QjtBQUNBd0IsaUJBQWFDLE9BQWIsQ0FBcUJDLEtBQUtBLEVBQUVDLElBQUYsR0FBUyxJQUFJQyxJQUFKLENBQVNGLEVBQUVDLElBQVgsQ0FBbkM7QUFDQSxXQUFPSCxZQUFQO0FBQ0Q7O0FBbFFzRDtrQkFBcENsQyxhIiwiZmlsZSI6Imhpc3RvcnkuY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgTWV0YUFwaUNsaWVudCBmcm9tICcuLi9tZXRhQXBpLmNsaWVudCc7XG5pbXBvcnQgcmFuZG9tc3RyaW5nIGZyb20gJ3JhbmRvbXN0cmluZyc7XG5cbi8qKlxuICogbWV0YWFwaS5jbG91ZCBDb3B5RmFjdG9yeSBoaXN0b3J5IEFQSSAodHJhZGUgY29weWluZyBoaXN0b3J5IEFQSSkgY2xpZW50IChzZWVcbiAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5LylcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGlzdG9yeUNsaWVudCBleHRlbmRzIE1ldGFBcGlDbGllbnQge1xuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIENvcHlGYWN0b3J5IGhpc3RvcnkgQVBJIGNsaWVudCBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge0h0dHBDbGllbnR9IGh0dHBDbGllbnQgSFRUUCBjbGllbnRcbiAgICogQHBhcmFtIHtTdHJpbmd9IHRva2VuIGF1dGhvcml6YXRpb24gdG9rZW5cbiAgICogQHBhcmFtIHtTdHJpbmd9IGRvbWFpbiBkb21haW4gdG8gY29ubmVjdCB0bywgZGVmYXVsdCBpcyBhZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpXG4gICAqL1xuICBjb25zdHJ1Y3RvcihodHRwQ2xpZW50LCB0b2tlbiwgZG9tYWluID0gJ2FnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWknKSB7XG4gICAgc3VwZXIoaHR0cENsaWVudCwgdG9rZW4sIGRvbWFpbik7XG4gICAgdGhpcy5faG9zdCA9IGBodHRwczovL3RyYWRpbmctYXBpLXYxLiR7ZG9tYWlufWA7XG4gIH1cblxuICAvKipcbiAgICogQ29weUZhY3RvcnkgcHJvdmlkZXIgb3Igc3Vic2NyaWJlclxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDb3B5RmFjdG9yeVN1YnNjcmliZXJPclByb3ZpZGVyXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBpZCBwcm9maWxlIGlkXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBuYW1lIHVzZXIgbmFtZVxuICAgKiBAcHJvcGVydHkge0FycmF5PENvcHlGYWN0b3J5U3RyYXRlZ3lJZEFuZE5hbWU+fSBzdHJhdGVnaWVzIGFycmF5IG9mIHN0cmF0ZWd5IElEcyBwcm92aWRlZCBieSBwcm92aWRlciBvciBzdWJzY3JpYmVkIHRvIGJ5XG4gICAqIHN1YnNjcmliZXJcbiAgICovXG5cbiAgLyoqXG4gICAqIENvcHlGYWN0b3J5IHN0cmF0ZWd5IGlkIGFuZCBuYW1lXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENvcHlGYWN0b3J5U3RyYXRlZ3lJZEFuZE5hbWVcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IGlkIHVuaXF1ZSBzdHJhdGVneSBpZFxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gbmFtZSBodW1hbi1yZWFkYWJsZSBzdHJhdGVneSBuYW1lXG4gICAqL1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGxpc3Qgb2YgcHJvdmlkZXJzIHByb3ZpZGluZyBzdHJhdGVnaWVzIHRvIHRoZSBjdXJyZW50IHVzZXJcbiAgICogaHR0cHM6Ly9tZXRhYXBpLmNsb3VkL2RvY3MvY29weWZhY3RvcnkvcmVzdEFwaS9hcGkvaGlzdG9yeS9nZXRQcm92aWRlcnMvXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8Q29weUZhY3RvcnlTdWJzY3JpYmVyT3JQcm92aWRlcj4+fSBwcm9taXNlIHJlc29sdmluZyB3aXRoIHByb3ZpZGVycyBmb3VuZFxuICAgKi9cbiAgZ2V0UHJvdmlkZXJzKCkge1xuICAgIGlmICh0aGlzLl9pc05vdEp3dFRva2VuKCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVOb0FjY2Vzc0Vycm9yKCdnZXRQcm92aWRlcnMnKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgIHVybDogYCR7dGhpcy5faG9zdH0vdXNlcnMvY3VycmVudC9wcm92aWRlcnNgLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ2F1dGgtdG9rZW4nOiB0aGlzLl90b2tlblxuICAgICAgfSxcbiAgICAgIGpzb246IHRydWVcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLl9odHRwQ2xpZW50LnJlcXVlc3Qob3B0cyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBsaXN0IG9mIHN1YnNjcmliZXJzIHN1YnNjcmliZWQgdG8gdGhlIHN0cmF0ZWdpZXMgb2YgdGhlIGN1cnJlbnQgdXNlclxuICAgKiBodHRwczovL21ldGFhcGkuY2xvdWQvZG9jcy9jb3B5ZmFjdG9yeS9yZXN0QXBpL2FwaS9oaXN0b3J5L2dldFN1YnNjcmliZXJzL1xuICAgKiBAcmV0dXJuIHtQcm9taXNlPEFycmF5PENvcHlGYWN0b3J5U3Vic2NyaWJlck9yUHJvdmlkZXI+Pn0gcHJvbWlzZSByZXNvbHZpbmcgd2l0aCBzdWJzY3JpYmVycyBmb3VuZFxuICAgKi9cbiAgZ2V0U3Vic2NyaWJlcnMoKSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ2dldFN1YnNjcmliZXJzJyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB1cmw6IGAke3RoaXMuX2hvc3R9L3VzZXJzL2N1cnJlbnQvc3Vic2NyaWJlcnNgLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ2F1dGgtdG9rZW4nOiB0aGlzLl90b2tlblxuICAgICAgfSxcbiAgICAgIGpzb246IHRydWVcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLl9odHRwQ2xpZW50LnJlcXVlc3Qob3B0cyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBsaXN0IG9mIHN0cmF0ZWdpZXMgdGhlIGN1cnJlbnQgdXNlciBpcyBzdWJzY3JpYmVkIHRvXG4gICAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5L3Jlc3RBcGkvYXBpL2hpc3RvcnkvZ2V0U3RyYXRlZ2llc1N1YnNjcmliZWQvXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8Q29weUZhY3RveVN0cmF0ZWd5SWRBbmROYW1lPj59IHByb21pc2UgcmVzb2x2aW5nIHdpdGggc3RyYXRlZ2llcyBmb3VuZFxuICAgKi9cbiAgZ2V0U3RyYXRlZ2llc1N1YnNjcmliZWQoKSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ2dldFN0cmF0ZWdpZXNTdWJzY3JpYmVkJyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB1cmw6IGAke3RoaXMuX2hvc3R9L3VzZXJzL2N1cnJlbnQvc3RyYXRlZ2llcy1zdWJzY3JpYmVkYCxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgIH0sXG4gICAgICBqc29uOiB0cnVlXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5faHR0cENsaWVudC5yZXF1ZXN0KG9wdHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgbGlzdCBvZiBzdHJhdGVnaWVzIHRoZSBjdXJyZW50IHVzZXIgcHJvdmlkZXMgdG8gb3RoZXIgdXNlcnNcbiAgICogaHR0cHM6Ly9tZXRhYXBpLmNsb3VkL2RvY3MvY29weWZhY3RvcnkvcmVzdEFwaS9hcGkvaGlzdG9yeS9nZXRQcm92aWRlZFN0cmF0ZWdpZXMvXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8Q29weUZhY3RvcnlTdHJhdGVneUlkQW5kTmFtZT4+fSBwcm9taXNlIHJlc29sdmluZyB3aXRoIHN0cmF0ZWdpZXMgZm91bmRcbiAgICovXG4gIGdldFByb3ZpZGVkU3RyYXRlZ2llcygpIHtcbiAgICBpZiAodGhpcy5faXNOb3RKd3RUb2tlbigpKSB7XG4gICAgICByZXR1cm4gdGhpcy5faGFuZGxlTm9BY2Nlc3NFcnJvcignZ2V0UHJvdmlkZWRTdHJhdGVnaWVzJyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB1cmw6IGAke3RoaXMuX2hvc3R9L3VzZXJzL2N1cnJlbnQvcHJvdmlkZWQtc3RyYXRlZ2llc2AsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuX2h0dHBDbGllbnQucmVxdWVzdChvcHRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb3B5RmFjdG9yeSB0cmFuc2FjdGlvblxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDb3B5RmFjdG9yeVRyYW5zYWN0aW9uXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBpZCB0cmFuc2FjdGlvbiBpZFxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gdHlwZSB0cmFuc2FjdGlvbiB0eXBlIChvbmUgb2YgREVBTF9UWVBFX0JVWSwgREVBTF9UWVBFX1NFTEwsIERFQUxfVFlQRV9CQUxBTkNFLFxuICAgKiBERUFMX1RZUEVfQ1JFRElULCBERUFMX1RZUEVfQ0hBUkdFLCBERUFMX1RZUEVfQ09SUkVDVElPTiwgREVBTF9UWVBFX0JPTlVTLCBERUFMX1RZUEVfQ09NTUlTU0lPTixcbiAgICogREVBTF9UWVBFX0NPTU1JU1NJT05fREFJTFksIERFQUxfVFlQRV9DT01NSVNTSU9OX01PTlRITFksIERFQUxfVFlQRV9DT01NSVNTSU9OX0FHRU5UX0RBSUxZLFxuICAgKiBERUFMX1RZUEVfQ09NTUlTU0lPTl9BR0VOVF9NT05USExZLCBERUFMX1RZUEVfSU5URVJFU1QsIERFQUxfVFlQRV9CVVlfQ0FOQ0VMRUQsIERFQUxfVFlQRV9TRUxMX0NBTkNFTEVELFxuICAgKiBERUFMX0RJVklERU5ELCBERUFMX0RJVklERU5EX0ZSQU5LRUQsIERFQUxfVEFYKS4gU2VlXG4gICAqIGh0dHBzOi8vd3d3Lm1xbDUuY29tL2VuL2RvY3MvY29uc3RhbnRzL3RyYWRpbmdjb25zdGFudHMvZGVhbHByb3BlcnRpZXMjZW51bV9kZWFsX3R5cGVcbiAgICogQHByb3BlcnR5IHtEYXRlfSB0aW1lIHRyYW5zYWN0aW9uIHRpbWVcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IGFjY291bnRJZCBDb3B5RmFjdG9yeSBhY2NvdW50IGlkXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBbc3ltYm9sXSBvcHRpb25hbCBzeW1ib2wgdHJhZGVkXG4gICAqIEBwcm9wZXJ0eSB7Q29weUZhY3RvcnlTdWJzY3JpYmVyT3JQcm92aWRlcn0gc3Vic2NyaWJlciBzdHJhdGVneSBzdWJzY3JpYmVyXG4gICAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gZGVtbyBkZW1vIGFjY291bnQgZmxhZ1xuICAgKiBAcHJvcGVydHkge0NvcHlGYWN0b3J5U3Vic2NyaWJlck9yUHJvdmlkZXJ9IHByb3ZpZGVyIHN0cmF0ZWd5IHByb3ZpZGVyXG4gICAqIEBwcm9wZXJ0eSB7Q29weUZhY3RvcnlTdHJhdGVneUlkQW5kTmFtZX0gc3RyYXRlZ3kgc3RyYXRlZ3lcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IFtwb3NpdGlvbklkXSBzb3VyY2UgcG9zaXRpb24gaWRcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IGltcHJvdmVtZW50IGhpZ2gtd2F0ZXIgbWFyayBzdHJhdGVneSBiYWxhbmNlIGltcHJvdmVtZW50XG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcm92aWRlckNvbW1pc3Npb24gcHJvdmlkZXIgY29tbWlzc2lvblxuICAgKiBAcHJvcGVydHkge051bWJlcn0gcGxhdGZvcm1Db21taXNzaW9uIHBsYXRmb3JtIGNvbW1pc3Npb25cbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFtpbmNvbWluZ1Byb3ZpZGVyQ29tbWlzc2lvbl0gY29tbWlzc2lvbiBwYWlkIGJ5IHByb3ZpZGVyIHRvIHVuZGVybHlpbmcgcHJvdmlkZXJzXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbaW5jb21pbmdQbGF0Zm9ybUNvbW1pc3Npb25dIHBsYXRmb3JtIGNvbW1pc3Npb24gcGFpZCBieSBwcm92aWRlciB0byB1bmRlcmx5aW5nIHByb3ZpZGVyc1xuICAgKiBAcHJvcGVydHkge051bWJlcn0gW2xvdFByaWNlXSB0cmFkZSBsb3QgcHJpY2VcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFt0aWNrUHJpY2VdIHRyYWRlIHRpY2sgcHJpY2VcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFthbW91bnRdIHRyYWRlIGFtb3VudFxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW2NvbW1pc3Npb25dIHRyYWRlIGNvbW1pc3Npb25cbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHN3YXAgdHJhZGUgc3dhcFxuICAgKiBAcHJvcGVydHkge051bWJlcn0gcHJvZml0IHRyYWRlIHByb2ZpdFxuICAgKiBAcHJvcGVydHkge0NvcHlGYWN0b3J5VHJhbnNhY3Rpb25NZXRyaWNzfSBbbWV0cmljc10gdHJhZGUgY29weWluZyBtZXRyaWNzIHN1Y2ggYXMgc2xpcHBhZ2UgYW5kIGxhdGVuY2llcy4gTWVhc3VyZWRcbiAgICogc2VsZWN0aXZlbHkgZm9yIGNvcGllZCB0cmFkZXNcbiAgICovXG5cbiAgLyoqXG4gICAqIFRyYWRlIGNvcHlpbmcgbWV0cmljcyBzdWNoIGFzIHNsaXBwYWdlIGFuZCBsYXRlbmNpZXNcbiAgICogQHR5cGVkZWYge09iamVjdH0gQ29weUZhY3RvcnlUcmFuc2FjdGlvbk1ldHJpY3NcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFt0cmFkZUNvcHlpbmdMYXRlbmN5XSB0cmFkZSBjb3B5aW5nIGxhdGVuY3ksIG1lYXN1cmVkIGluIG1pbGxpc2Vjb25kcyBiYXNlZCBvbiB0cmFuc2FjdGlvbiB0aW1lXG4gICAqIHByb3ZpZGVkIGJ5IGJyb2tlclxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RyYWRlQ29weWluZ1NsaXBwYWdlSW5CYXNpc1BvaW50c10gdHJhZGUgY29weWluZyBzbGlwcGFnZSwgbWVhc3VyZWQgaW4gYmFzaXMgcG9pbnRzICgwLjAxXG4gICAqIHBlcmNlbnQpIGJhc2VkIG9uIHRyYW5zYWN0aW9uIHByaWNlIHByb3ZpZGVkIGJ5IGJyb2tlclxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RyYWRlQ29weWluZ1NsaXBwYWdlSW5BY2NvdW50Q3VycmVuY3ldIHRyYWRlIGNvcHlpbmcgc2xpcHBhZ2UsIG1lYXN1cmVkIGluIGFjY291bnQgY3VycmVuY3lcbiAgICogYmFzZWQgb24gdHJhbnNhY3Rpb24gcHJpY2UgcHJvdmlkZWQgYnkgYnJva2VyXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbbXRBbmRCcm9rZXJTaWduYWxMYXRlbmN5XSB0cmFkZSBzaWduYWwgbGF0ZW5jeSBpbnRyb2R1Y2VkIGJ5IGJyb2tlciBhbmQgTVQgcGxhdGZvcm0sIG1lYXN1cmVkXG4gICAqIGluIG1pbGxpc2Vjb25kc1xuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RyYWRlQWxnb3JpdGhtTGF0ZW5jeV0gdHJhZGUgYWxnb3JpdGhtIGxhdGVuY3kgaW50cm9kdWNlZCBieSBDb3B5RmFjdG9yeSBzZXJ2ZXJzLCBtZWFzdXJlZCBpblxuICAgKiBtaWxsaXNlY29uZHNcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFttdEFuZEJyb2tlclRyYWRlTGF0ZW5jeV0gdHJhZGUgbGF0ZW5jeSBmb3IgYSBjb3BpZWQgdHJhZGUgaW50cm9kdWNlZCBieSBicm9rZXIgYW5kIE1UIHBsYXRmb3JtLFxuICAgKiBtZWFzdXJlZCBpbiBtaWxsaXNlY29uZHNcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFt0b3RhbExhdGVuY3ldIHRvdGFsIHRyYWRlIGNvcHlpbmcgbGF0ZW5jeSwgbWVhc3VyZWQgaW4gbWlsbGlzZWNvbmRzLiBUaGlzIHZhbHVlIG1pZ2h0IGJlXG4gICAqIHNsaWdodGx5IGRpZmZlcmVudCBmcm9tIHRyYWRlQ29weWluZ0xhdGVuY3kgdmFsdWUgZHVlIHRvIGxpbWl0ZWQgbWVhc3VyZW1lbnQgcHJlY2lzaW9uIGFzIGl0IGlzIG1lYXN1cmVkIGJhc2VkXG4gICAqIG9uIHRpbWVzdGFtcHMgY2FwdHVyZWQgZHVyaW5nIGNvcHkgdHJhZGluZyBwcm9jZXNzIGFzIG9wcG9zZWQgdG8gYnJva2VyIGRhdGFcbiAgICovXG5cbiAgLyoqXG4gICAqIFJldHVybnMgbGlzdCBvZiB0cmFuc2FjdGlvbnMgb24gdGhlIHN0cmF0ZWdpZXMgdGhlIGN1cnJlbnQgdXNlciBwcm92aWRlcyB0byBvdGhlciB1c2Vyc1xuICAgKiBodHRwczovL21ldGFhcGkuY2xvdWQvZG9jcy9jb3B5ZmFjdG9yeS9yZXN0QXBpL2FwaS9oaXN0b3J5L2dldFByb3ZpZGVkU3RyYXRlZ2llc1RyYW5zYWN0aW9ucy9cbiAgICogQHBhcmFtIHtEYXRlfSBmcm9tIHRpbWUgdG8gbG9hZCB0cmFuc2FjdGlvbnMgZnJvbVxuICAgKiBAcGFyYW0ge0RhdGV9IHRpbGwgdGltZSB0byBsb2FkIHRyYW5zYWN0aW9ucyB0aWxsXG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gW3N0cmF0ZWd5SWRzXSBvcHRpb25hbCBsaXN0IG9mIHN0cmF0ZWd5IGlkcyB0byBmaWx0ZXIgdHJhbnNhY3Rpb25zIGJ5XG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gW2FjY291bnRJZHNdIHRoZSBsaXN0IG9mIENvcHlGYWN0b3J5IHN1YnNjcmliZXIgYWNjb3VudCBpZCAoNjQtY2hhcmFjdGVyIGxvbmcpIHRvIGZpbHRlciBieVxuICAgKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IFtzdWJzY3JpYmVySWRzXSBvcHRpb25hbCBsaXN0IG9mIHN1YnNjcmliZXJzIHRvIGZpbHRlciB0cmFuc2FjdGlvbnMgYnlcbiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXRdIHBhZ2luYXRpb24gb2Zmc2V0LiBEZWZhdWx0IHZhbHVlIGlzIDBcbiAgICogQHBhcmFtIHtudW1iZXJ9IFtsaW1pdF0gcGFnaW5hdGlvbiBsaW1pdC4gRGVmYXVsdCB2YWx1ZSBpcyAxMDAwXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8Q29weUZhY3RvcnlUcmFuc2FjdGlvbj4+fSBwcm9taXNlIHJlc29sdmluZyB3aXRoIHRyYW5zYWN0aW9ucyBmb3VuZFxuICAgKi9cbiAgYXN5bmMgZ2V0UHJvdmlkZWRTdHJhdGVnaWVzVHJhbnNhY3Rpb25zKGZyb20sIHRpbGwsIHN0cmF0ZWd5SWRzLCBhY2NvdW50SWRzLCBzdWJzY3JpYmVySWRzLCBvZmZzZXQsIGxpbWl0KSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ2dldFByb3ZpZGVkU3RyYXRlZ2llc1RyYW5zYWN0aW9ucycpO1xuICAgIH1cbiAgICBsZXQgcXMgPSB7XG4gICAgICBmcm9tLFxuICAgICAgdGlsbFxuICAgIH07XG4gICAgaWYgKHN0cmF0ZWd5SWRzKSB7XG4gICAgICBxcy5zdHJhdGVneUlkID0gc3RyYXRlZ3lJZHM7XG4gICAgfVxuICAgIGlmIChzdWJzY3JpYmVySWRzKSB7XG4gICAgICBxcy5zdWJzY3JpYmVySWQgPSBzdWJzY3JpYmVySWRzO1xuICAgIH1cbiAgICBpZiAoYWNjb3VudElkcykge1xuICAgICAgcXMuYWNjb3VudElkID0gYWNjb3VudElkcztcbiAgICB9XG4gICAgaWYgKG9mZnNldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBxcy5vZmZzZXQgPSBvZmZzZXQ7XG4gICAgfVxuICAgIGlmIChsaW1pdCkge1xuICAgICAgcXMubGltaXQgPSBsaW1pdDtcbiAgICB9XG4gICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgIHVybDogYCR7dGhpcy5faG9zdH0vdXNlcnMvY3VycmVudC9wcm92aWRlZC1zdHJhdGVnaWVzL3RyYW5zYWN0aW9uc2AsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAgcXMsXG4gICAgICBqc29uOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgdHJhbnNhY3Rpb25zID0gYXdhaXQgdGhpcy5faHR0cENsaWVudC5yZXF1ZXN0KG9wdHMpO1xuICAgIHRyYW5zYWN0aW9ucy5mb3JFYWNoKHQgPT4gdC50aW1lID0gbmV3IERhdGUodC50aW1lKSk7XG4gICAgcmV0dXJuIHRyYW5zYWN0aW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGxpc3Qgb2YgdHJhZGVzIG9uIHRoZSBzdHJhdGVnaWVzIHRoZSBjdXJyZW50IHVzZXIgc3Vic2NyaWJlZCB0b1xuICAgKiBodHRwczovL21ldGFhcGkuY2xvdWQvZG9jcy9jb3B5ZmFjdG9yeS9yZXN0QXBpL2FwaS9oaXN0b3J5L2dldFN0cmF0ZWdpZXNTdWJzY3JpYmVkVHJhbnNhY3Rpb25zL1xuICAgKiBAcGFyYW0ge0RhdGV9IGZyb20gdGltZSB0byBsb2FkIHRyYW5zYWN0aW9ucyBmcm9tXG4gICAqIEBwYXJhbSB7RGF0ZX0gdGlsbCB0aW1lIHRvIGxvYWQgdHJhbnNhY3Rpb25zIHRpbGxcbiAgICogQHBhcmFtIHtBcnJheTxTdHJpbmc+fSBzdHJhdGVneUlkcyBvcHRpb25hbCBsaXN0IG9mIHN0cmF0ZWd5IGlkcyB0byBmaWx0ZXIgdHJhbnNhY3Rpb25zIGJ5XG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gW2FjY291bnRJZHNdIHRoZSBsaXN0IG9mIENvcHlGYWN0b3J5IHN1YnNjcmliZXIgYWNjb3VudCBpZCAoNjQtY2hhcmFjdGVyIGxvbmcpIHRvIGZpbHRlciBieVxuICAgKiBAcGFyYW0ge0FycmF5PFN0cmluZz59IHByb3ZpZGVySWRzIG9wdGlvbmFsIGxpc3Qgb2YgcHJvdmlkZXJzIHRvIGZpbHRlciB0cmFuc2FjdGlvbnMgYnlcbiAgICogQHBhcmFtIHtOdW1iZXJ9IG9mZnNldCBwYWdpbmF0aW9uIG9mZnNldC4gRGVmYXVsdCB2YWx1ZSBpcyAwXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBsaW1pdCBwYWdpbmF0aW9uIGxpbWl0LiBEZWZhdWx0IHZhbHVlIGlzIDEwMDBcbiAgICogQHJldHVybiB7UHJvbWlzZTxBcnJheTxDb3B5RmFjdG9yeVRyYW5zYWN0aW9uPj59IHByb21pc2UgcmVzb2x2aW5nIHdpdGggdHJhbnNhY3Rpb25zIGZvdW5kXG4gICAqL1xuICBhc3luYyBnZXRTdHJhdGVnaWVzU3Vic2NyaWJlZFRyYW5zYWN0aW9ucyhmcm9tLCB0aWxsLCBzdHJhdGVneUlkcywgYWNjb3VudElkcywgcHJvdmlkZXJJZHMsIG9mZnNldCwgbGltaXQpIHtcbiAgICBpZiAodGhpcy5faXNOb3RKd3RUb2tlbigpKSB7XG4gICAgICByZXR1cm4gdGhpcy5faGFuZGxlTm9BY2Nlc3NFcnJvcignZ2V0U3RyYXRlZ2llc1N1YnNjcmliZWRUcmFuc2FjdGlvbnMnKTtcbiAgICB9XG4gICAgbGV0IHFzID0ge1xuICAgICAgZnJvbSxcbiAgICAgIHRpbGxcbiAgICB9O1xuICAgIGlmIChzdHJhdGVneUlkcykge1xuICAgICAgcXMuc3RyYXRlZ3lJZCA9IHN0cmF0ZWd5SWRzO1xuICAgIH1cbiAgICBpZiAocHJvdmlkZXJJZHMpIHtcbiAgICAgIHFzLnByb3ZpZGVySWQgPSBwcm92aWRlcklkcztcbiAgICB9XG4gICAgaWYgKGFjY291bnRJZHMpIHtcbiAgICAgIHFzLmFjY291bnRJZCA9IGFjY291bnRJZHM7XG4gICAgfVxuICAgIGlmIChvZmZzZXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcXMub2Zmc2V0ID0gb2Zmc2V0O1xuICAgIH1cbiAgICBpZiAobGltaXQpIHtcbiAgICAgIHFzLmxpbWl0ID0gbGltaXQ7XG4gICAgfVxuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB1cmw6IGAke3RoaXMuX2hvc3R9L3VzZXJzL2N1cnJlbnQvc3RyYXRlZ2llcy1zdWJzY3JpYmVkL3RyYW5zYWN0aW9uc2AsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAgcXMsXG4gICAgICBqc29uOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgdHJhbnNhY3Rpb25zID0gYXdhaXQgdGhpcy5faHR0cENsaWVudC5yZXF1ZXN0KG9wdHMpO1xuICAgIHRyYW5zYWN0aW9ucy5mb3JFYWNoKHQgPT4gdC50aW1lID0gbmV3IERhdGUodC50aW1lKSk7XG4gICAgcmV0dXJuIHRyYW5zYWN0aW9ucztcbiAgfVxuXG59XG4iXX0=