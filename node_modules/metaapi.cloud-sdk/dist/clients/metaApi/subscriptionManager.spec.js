'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _subscriptionManager = require('./subscriptionManager');

var _subscriptionManager2 = _interopRequireDefault(_subscriptionManager);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _timeoutError = require('../timeoutError');

var _timeoutError2 = _interopRequireDefault(_timeoutError);

var _errorHandler = require('../errorHandler');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {SubscriptionManager}
 */
describe('SubscriptionManager', () => {
  let sandbox;
  let clock;
  let manager;
  let client;

  before(() => {
    sandbox = _sinon2.default.createSandbox();
    const mockMath = (0, _create2.default)(global.Math);
    mockMath.random = () => 0.2;
    global.Math = mockMath;
  });

  beforeEach(async () => {
    const socketInstances = [{ socket: { connected: true } }, { socket: { connected: false } }];
    client = {
      subscribe: () => {},
      connect: () => {},
      connected: socketInstanceIndex => socketInstances[socketInstanceIndex].socket.connected,
      socketInstances: socketInstances,
      socketInstancesByAccounts: { accountId: 0 }
    };
    clock = _sinon2.default.useFakeTimers({ shouldAdvanceTime: true });
    manager = new _subscriptionManager2.default(client);
  });

  afterEach(async () => {
    sandbox.restore();
    clock.restore();
  });

  /**
   * @test {SubscriptionManager#subscribe}
   */
  it('should subscribe to terminal', async () => {
    sandbox.stub(client, 'subscribe').resolves();
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
    }, 50);
    await manager.subscribe('accountId');
    _sinon2.default.assert.calledWith(client.subscribe, 'accountId', undefined);
  });

  /**
   * @test {SubscriptionManager#subscribe}
   */
  it('should retry subscribe if no response received', async () => {
    const response = { type: 'response', accountId: 'accountId', requestId: 'requestId' };
    sandbox.stub(client, 'subscribe').onFirstCall().resolves(new _timeoutError2.default('timeout')).onSecondCall().resolves(response).onThirdCall().resolves(response);
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
    }, 3600);
    manager.subscribe('accountId');
    await clock.tickAsync(10000);
    _sinon2.default.assert.calledTwice(client.subscribe);
    _sinon2.default.assert.calledWith(client.subscribe, 'accountId', undefined);
  });

  /**
   * @test {SubscriptionManager#subscribe}
   */
  it('should wait for recommended time if too many requests error received', async () => {
    const response = { type: 'response', accountId: 'accountId', requestId: 'requestId' };
    sandbox.stub(client, 'subscribe').onFirstCall().rejects(new _errorHandler.TooManyRequestsError('timeout', {
      periodInMinutes: 60, maxRequestsForPeriod: 10000,
      type: 'LIMIT_REQUEST_RATE_PER_USER',
      recommendedRetryTime: new Date(Date.now() + 5000) })).onSecondCall().resolves(response).onThirdCall().resolves(response);
    manager.subscribe('accountId');
    await clock.tickAsync(3600);
    _sinon2.default.assert.callCount(client.subscribe, 1);
    await clock.tickAsync(2000);
    manager.cancelSubscribe('accountId:0');
    _sinon2.default.assert.callCount(client.subscribe, 2);
  });

  /**
   * @test {SubscriptionManager#onReconnected}
   */
  it('should cancel all subscriptions on reconnect', async () => {
    sandbox.stub(client, 'subscribe').resolves();
    client.socketInstancesByAccounts = { accountId: 0, accountId2: 0, accountId3: 1 };
    manager.subscribe('accountId');
    manager.subscribe('accountId2');
    manager.subscribe('accountId3');
    await clock.tickAsync(1000);
    manager.onReconnected(0, []);
    await clock.tickAsync(5000);
    _sinon2.default.assert.callCount(client.subscribe, 4);
  });

  /**
   * @test {SubscriptionManager#onReconnected}
   */
  it('should restart subscriptions on reconnect', async () => {
    sandbox.stub(client, 'connect').resolves();
    sandbox.stub(client, 'subscribe').resolves();
    client.socketInstancesByAccounts = { accountId: 0, accountId2: 0, accountId3: 0 };
    manager.subscribe('accountId');
    manager.subscribe('accountId2');
    manager.subscribe('accountId3');
    await clock.tickAsync(1000);
    manager.onReconnected(0, ['accountId', 'accountId2']);
    await clock.tickAsync(2000);
    _sinon2.default.assert.callCount(client.subscribe, 5);
  });

  /**
   * @test {SubscriptionManager#onReconnected}
   */
  it('should wait until previous subscription ends on reconnect', async () => {
    sandbox.stub(client, 'subscribe').callsFake(async () => {
      await new _promise2.default(res => setTimeout(res, 2000));
    });

    sandbox.stub(client, 'connect').resolves();
    client.socketInstancesByAccounts = { accountId: 0 };
    manager.subscribe('accountId');
    await clock.tickAsync(1000);
    manager.onReconnected(0, ['accountId']);
    await clock.tickAsync(3000);
    _sinon2.default.assert.callCount(client.subscribe, 2);
  });

  /**
   * @test {SubscriptionManager#subscribe}
   */
  it('should not send multiple subscribe requests at the same time', async () => {
    sandbox.stub(client, 'subscribe').resolves();
    manager.subscribe('accountId');
    manager.subscribe('accountId');
    await clock.tickAsync(1000);
    manager.cancelSubscribe('accountId:0');
    await clock.tickAsync(2500);
    _sinon2.default.assert.calledWith(client.subscribe, 'accountId', undefined);
    _sinon2.default.assert.calledOnce(client.subscribe);
  });

  /**
   * @test {SubscriptionManager#onTimeout}
   */
  it('should resubscribe on timeout', async () => {
    sandbox.stub(client, 'subscribe').resolves();
    client.socketInstances[0].socket.connected = true;
    client.socketInstancesByAccounts.accountId2 = 1;
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
      manager.cancelSubscribe('accountId2:0');
    }, 100);
    manager.onTimeout('accountId');
    manager.onTimeout('accountId2');
    await clock.tickAsync(200);
    _sinon2.default.assert.calledWith(client.subscribe, 'accountId', undefined);
    _sinon2.default.assert.callCount(client.subscribe, 1);
  });

  /**
   * @test {SubscriptionManager#onTimeout}
   */
  it('should not retry subscribe to terminal if connection is closed', async () => {
    sandbox.stub(client, 'subscribe').resolves();
    client.socketInstances[0].socket.connected = false;
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
    }, 100);
    manager.onTimeout('accountId');
    await clock.tickAsync(200);
    _sinon2.default.assert.notCalled(client.subscribe);
  });

  /**
   * @test {SubscriptionManager#cancelAccount}
   */
  it('should cancel all subscriptions for an account', async () => {
    sandbox.stub(client, 'subscribe').resolves();
    manager.subscribe('accountId', 0);
    manager.subscribe('accountId', 1);
    await clock.tickAsync(100);
    manager.cancelAccount('accountId');
    await clock.tickAsync(500);
    _sinon2.default.assert.calledTwice(client.subscribe);
  });

  /**
   * @test {SubscriptionManager#cancelSubscribe}
   */
  it('should destroy subscribe process on cancel', async () => {
    const subscribe = sandbox.stub().resolves();
    const delaySubscribe = async () => {
      await subscribe();
      await new _promise2.default(res => setTimeout(res, 400));
    };
    client.subscribe = delaySubscribe;
    manager.subscribe('accountId');
    await clock.tickAsync(50);
    manager.cancelSubscribe('accountId:0');
    await clock.tickAsync(50);
    manager.subscribe('accountId');
    await clock.tickAsync(50);
    _sinon2.default.assert.calledTwice(subscribe);
  });

  /**
   * @test {SubscriptionManager#cancelSubscribe}
   */
  it('should check if account is subscribing', async () => {
    manager.subscribe('accountId', 1);
    await clock.tickAsync(50);
    _sinon2.default.assert.match(manager.isAccountSubscribing('accountId'), true);
    _sinon2.default.assert.match(manager.isAccountSubscribing('accountId', 0), false);
    _sinon2.default.assert.match(manager.isAccountSubscribing('accountId', 1), true);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvc3Vic2NyaXB0aW9uTWFuYWdlci5zcGVjLmVzNiJdLCJuYW1lcyI6WyJkZXNjcmliZSIsInNhbmRib3giLCJjbG9jayIsIm1hbmFnZXIiLCJjbGllbnQiLCJiZWZvcmUiLCJzaW5vbiIsImNyZWF0ZVNhbmRib3giLCJtb2NrTWF0aCIsImdsb2JhbCIsIk1hdGgiLCJyYW5kb20iLCJiZWZvcmVFYWNoIiwic29ja2V0SW5zdGFuY2VzIiwic29ja2V0IiwiY29ubmVjdGVkIiwic3Vic2NyaWJlIiwiY29ubmVjdCIsInNvY2tldEluc3RhbmNlSW5kZXgiLCJzb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzIiwiYWNjb3VudElkIiwidXNlRmFrZVRpbWVycyIsInNob3VsZEFkdmFuY2VUaW1lIiwiU3Vic2NyaXB0aW9uTWFuYWdlciIsImFmdGVyRWFjaCIsInJlc3RvcmUiLCJpdCIsInN0dWIiLCJyZXNvbHZlcyIsInNldFRpbWVvdXQiLCJjYW5jZWxTdWJzY3JpYmUiLCJhc3NlcnQiLCJjYWxsZWRXaXRoIiwidW5kZWZpbmVkIiwicmVzcG9uc2UiLCJ0eXBlIiwicmVxdWVzdElkIiwib25GaXJzdENhbGwiLCJUaW1lb3V0RXJyb3IiLCJvblNlY29uZENhbGwiLCJvblRoaXJkQ2FsbCIsInRpY2tBc3luYyIsImNhbGxlZFR3aWNlIiwicmVqZWN0cyIsIlRvb01hbnlSZXF1ZXN0c0Vycm9yIiwicGVyaW9kSW5NaW51dGVzIiwibWF4UmVxdWVzdHNGb3JQZXJpb2QiLCJyZWNvbW1lbmRlZFJldHJ5VGltZSIsIkRhdGUiLCJub3ciLCJjYWxsQ291bnQiLCJhY2NvdW50SWQyIiwiYWNjb3VudElkMyIsIm9uUmVjb25uZWN0ZWQiLCJjYWxsc0Zha2UiLCJyZXMiLCJjYWxsZWRPbmNlIiwib25UaW1lb3V0Iiwibm90Q2FsbGVkIiwiY2FuY2VsQWNjb3VudCIsImRlbGF5U3Vic2NyaWJlIiwibWF0Y2giLCJpc0FjY291bnRT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YixDQUFtQjFELFFBQVEyRCxvQkFBUixDQUE2QixXQUE3QixFQUEwQyxDQUExQyxDQUFuQixFQUFpRSxLQUFqRTtBQUNBeEQsb0JBQU15QixNQUFOLENBQWE4QixLQUFiLENBQW1CMUQsUUFBUTJELG9CQUFSLENBQTZCLFdBQTdCLEVBQTBDLENBQTFDLENBQW5CLEVBQWlFLElBQWpFO0FBQ0QsR0FORDtBQVFELENBMU5EIiwiZmlsZSI6InN1YnNjcmlwdGlvbk1hbmFnZXIuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTdWJzY3JpcHRpb25NYW5hZ2VyIGZyb20gJy4vc3Vic2NyaXB0aW9uTWFuYWdlcic7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IFRpbWVvdXRFcnJvciBmcm9tICcuLi90aW1lb3V0RXJyb3InO1xuaW1wb3J0IHsgVG9vTWFueVJlcXVlc3RzRXJyb3IgfSBmcm9tICcuLi9lcnJvckhhbmRsZXInO1xuXG4vKipcbiAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyfVxuICovXG5kZXNjcmliZSgnU3Vic2NyaXB0aW9uTWFuYWdlcicsICgpID0+IHtcbiAgbGV0IHNhbmRib3g7XG4gIGxldCBjbG9jaztcbiAgbGV0IG1hbmFnZXI7XG4gIGxldCBjbGllbnQ7XG5cbiAgYmVmb3JlKCgpID0+IHtcbiAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpO1xuICAgIGNvbnN0IG1vY2tNYXRoID0gT2JqZWN0LmNyZWF0ZShnbG9iYWwuTWF0aCk7XG4gICAgbW9ja01hdGgucmFuZG9tID0gKCkgPT4gMC4yO1xuICAgIGdsb2JhbC5NYXRoID0gbW9ja01hdGg7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4geyAgXG4gICAgY29uc3Qgc29ja2V0SW5zdGFuY2VzID0gW3tzb2NrZXQ6IHtjb25uZWN0ZWQ6IHRydWV9fSwge3NvY2tldDoge2Nvbm5lY3RlZDogZmFsc2V9fV07XG4gICAgY2xpZW50ID0ge1xuICAgICAgc3Vic2NyaWJlOiAoKSA9PiB7fSxcbiAgICAgIGNvbm5lY3Q6ICgpID0+IHt9LFxuICAgICAgY29ubmVjdGVkOiAoc29ja2V0SW5zdGFuY2VJbmRleCkgPT4gc29ja2V0SW5zdGFuY2VzW3NvY2tldEluc3RhbmNlSW5kZXhdLnNvY2tldC5jb25uZWN0ZWQsXG4gICAgICBzb2NrZXRJbnN0YW5jZXM6IHNvY2tldEluc3RhbmNlcyxcbiAgICAgIHNvY2tldEluc3RhbmNlc0J5QWNjb3VudHM6IHthY2NvdW50SWQ6IDB9XG4gICAgfTtcbiAgICBjbG9jayA9IHNpbm9uLnVzZUZha2VUaW1lcnMoe3Nob3VsZEFkdmFuY2VUaW1lOiB0cnVlfSk7XG4gICAgbWFuYWdlciA9IG5ldyBTdWJzY3JpcHRpb25NYW5hZ2VyKGNsaWVudCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgc2FuZGJveC5yZXN0b3JlKCk7XG4gICAgY2xvY2sucmVzdG9yZSgpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjc3Vic2NyaWJlfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBzdWJzY3JpYmUgdG8gdGVybWluYWwnLCBhc3luYyAoKSA9PiB7XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3N1YnNjcmliZScpLnJlc29sdmVzKCk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBtYW5hZ2VyLmNhbmNlbFN1YnNjcmliZSgnYWNjb3VudElkOjAnKTtcbiAgICB9LCA1MCk7XG4gICAgYXdhaXQgbWFuYWdlci5zdWJzY3JpYmUoJ2FjY291bnRJZCcpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNsaWVudC5zdWJzY3JpYmUsICdhY2NvdW50SWQnLCB1bmRlZmluZWQpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjc3Vic2NyaWJlfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXRyeSBzdWJzY3JpYmUgaWYgbm8gcmVzcG9uc2UgcmVjZWl2ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSB7dHlwZTogJ3Jlc3BvbnNlJywgYWNjb3VudElkOiAnYWNjb3VudElkJywgcmVxdWVzdElkOiAncmVxdWVzdElkJ307XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3N1YnNjcmliZScpXG4gICAgICAub25GaXJzdENhbGwoKS5yZXNvbHZlcyhuZXcgVGltZW91dEVycm9yKCd0aW1lb3V0JykpXG4gICAgICAub25TZWNvbmRDYWxsKCkucmVzb2x2ZXMocmVzcG9uc2UpXG4gICAgICAub25UaGlyZENhbGwoKS5yZXNvbHZlcyhyZXNwb25zZSk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBtYW5hZ2VyLmNhbmNlbFN1YnNjcmliZSgnYWNjb3VudElkOjAnKTtcbiAgICB9LCAzNjAwKTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkJyk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDEwMDAwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkVHdpY2UoY2xpZW50LnN1YnNjcmliZSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoY2xpZW50LnN1YnNjcmliZSwgJ2FjY291bnRJZCcsIHVuZGVmaW5lZCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNzdWJzY3JpYmV9XG4gICAqL1xuICBpdCgnc2hvdWxkIHdhaXQgZm9yIHJlY29tbWVuZGVkIHRpbWUgaWYgdG9vIG1hbnkgcmVxdWVzdHMgZXJyb3IgcmVjZWl2ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSB7dHlwZTogJ3Jlc3BvbnNlJywgYWNjb3VudElkOiAnYWNjb3VudElkJywgcmVxdWVzdElkOiAncmVxdWVzdElkJ307XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3N1YnNjcmliZScpXG4gICAgICAub25GaXJzdENhbGwoKS5yZWplY3RzKG5ldyBUb29NYW55UmVxdWVzdHNFcnJvcigndGltZW91dCcsIHtcbiAgICAgICAgcGVyaW9kSW5NaW51dGVzOiA2MCwgbWF4UmVxdWVzdHNGb3JQZXJpb2Q6IDEwMDAwLFxuICAgICAgICB0eXBlOiAnTElNSVRfUkVRVUVTVF9SQVRFX1BFUl9VU0VSJyxcbiAgICAgICAgcmVjb21tZW5kZWRSZXRyeVRpbWU6IG5ldyBEYXRlKERhdGUubm93KCkgKyA1MDAwKX0pKVxuICAgICAgLm9uU2Vjb25kQ2FsbCgpLnJlc29sdmVzKHJlc3BvbnNlKVxuICAgICAgLm9uVGhpcmRDYWxsKCkucmVzb2x2ZXMocmVzcG9uc2UpO1xuICAgIG1hbmFnZXIuc3Vic2NyaWJlKCdhY2NvdW50SWQnKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMzYwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChjbGllbnQuc3Vic2NyaWJlLCAxKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMjAwMCk7XG4gICAgbWFuYWdlci5jYW5jZWxTdWJzY3JpYmUoJ2FjY291bnRJZDowJyk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChjbGllbnQuc3Vic2NyaWJlLCAyKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI29uUmVjb25uZWN0ZWR9XG4gICAqL1xuICBpdCgnc2hvdWxkIGNhbmNlbCBhbGwgc3Vic2NyaXB0aW9ucyBvbiByZWNvbm5lY3QnLCBhc3luYyAoKSA9PiB7XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3N1YnNjcmliZScpLnJlc29sdmVzKCk7XG4gICAgY2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHMgPSB7YWNjb3VudElkOiAwLCBhY2NvdW50SWQyOiAwLCBhY2NvdW50SWQzOiAxfTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkJyk7XG4gICAgbWFuYWdlci5zdWJzY3JpYmUoJ2FjY291bnRJZDInKTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkMycpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxMDAwKTtcbiAgICBtYW5hZ2VyLm9uUmVjb25uZWN0ZWQoMCwgW10pO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg1MDAwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbENvdW50KGNsaWVudC5zdWJzY3JpYmUsIDQpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjb25SZWNvbm5lY3RlZH1cbiAgICovXG4gIGl0KCdzaG91bGQgcmVzdGFydCBzdWJzY3JpcHRpb25zIG9uIHJlY29ubmVjdCcsIGFzeW5jICgpID0+IHtcbiAgICBzYW5kYm94LnN0dWIoY2xpZW50LCAnY29ubmVjdCcpLnJlc29sdmVzKCk7XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3N1YnNjcmliZScpLnJlc29sdmVzKCk7XG4gICAgY2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHMgPSB7YWNjb3VudElkOiAwLCBhY2NvdW50SWQyOiAwLCBhY2NvdW50SWQzOiAwfTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkJyk7XG4gICAgbWFuYWdlci5zdWJzY3JpYmUoJ2FjY291bnRJZDInKTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkMycpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxMDAwKTtcbiAgICBtYW5hZ2VyLm9uUmVjb25uZWN0ZWQoMCwgWydhY2NvdW50SWQnLCAnYWNjb3VudElkMiddKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMjAwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChjbGllbnQuc3Vic2NyaWJlLCA1KTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI29uUmVjb25uZWN0ZWR9XG4gICAqL1xuICBpdCgnc2hvdWxkIHdhaXQgdW50aWwgcHJldmlvdXMgc3Vic2NyaXB0aW9uIGVuZHMgb24gcmVjb25uZWN0JywgYXN5bmMgKCkgPT4ge1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdzdWJzY3JpYmUnKS5jYWxsc0Zha2UoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCAyMDAwKSk7XG4gICAgfSk7XG5cbiAgICBzYW5kYm94LnN0dWIoY2xpZW50LCAnY29ubmVjdCcpLnJlc29sdmVzKCk7XG4gICAgY2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHMgPSB7YWNjb3VudElkOiAwfTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkJyk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDEwMDApO1xuICAgIG1hbmFnZXIub25SZWNvbm5lY3RlZCgwLCBbJ2FjY291bnRJZCddKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMzAwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChjbGllbnQuc3Vic2NyaWJlLCAyKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI3N1YnNjcmliZX1cbiAgICovXG4gIGl0KCdzaG91bGQgbm90IHNlbmQgbXVsdGlwbGUgc3Vic2NyaWJlIHJlcXVlc3RzIGF0IHRoZSBzYW1lIHRpbWUnLCBhc3luYyAoKSA9PiB7XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3N1YnNjcmliZScpLnJlc29sdmVzKCk7XG4gICAgbWFuYWdlci5zdWJzY3JpYmUoJ2FjY291bnRJZCcpO1xuICAgIG1hbmFnZXIuc3Vic2NyaWJlKCdhY2NvdW50SWQnKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMTAwMCk7XG4gICAgbWFuYWdlci5jYW5jZWxTdWJzY3JpYmUoJ2FjY291bnRJZDowJyk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDI1MDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNsaWVudC5zdWJzY3JpYmUsICdhY2NvdW50SWQnLCB1bmRlZmluZWQpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRPbmNlKGNsaWVudC5zdWJzY3JpYmUpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjb25UaW1lb3V0fVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXN1YnNjcmliZSBvbiB0aW1lb3V0JywgYXN5bmMgKCkgPT4ge1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdzdWJzY3JpYmUnKS5yZXNvbHZlcygpO1xuICAgIGNsaWVudC5zb2NrZXRJbnN0YW5jZXNbMF0uc29ja2V0LmNvbm5lY3RlZCA9IHRydWU7XG4gICAgY2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHMuYWNjb3VudElkMiA9IDE7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBtYW5hZ2VyLmNhbmNlbFN1YnNjcmliZSgnYWNjb3VudElkOjAnKTtcbiAgICAgIG1hbmFnZXIuY2FuY2VsU3Vic2NyaWJlKCdhY2NvdW50SWQyOjAnKTtcbiAgICB9LCAxMDApO1xuICAgIG1hbmFnZXIub25UaW1lb3V0KCdhY2NvdW50SWQnKTtcbiAgICBtYW5hZ2VyLm9uVGltZW91dCgnYWNjb3VudElkMicpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygyMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNsaWVudC5zdWJzY3JpYmUsICdhY2NvdW50SWQnLCB1bmRlZmluZWQpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsQ291bnQoY2xpZW50LnN1YnNjcmliZSwgMSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNvblRpbWVvdXR9XG4gICAqL1xuICBpdCgnc2hvdWxkIG5vdCByZXRyeSBzdWJzY3JpYmUgdG8gdGVybWluYWwgaWYgY29ubmVjdGlvbiBpcyBjbG9zZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3N1YnNjcmliZScpLnJlc29sdmVzKCk7XG4gICAgY2xpZW50LnNvY2tldEluc3RhbmNlc1swXS5zb2NrZXQuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBtYW5hZ2VyLmNhbmNlbFN1YnNjcmliZSgnYWNjb3VudElkOjAnKTtcbiAgICB9LCAxMDApO1xuICAgIG1hbmFnZXIub25UaW1lb3V0KCdhY2NvdW50SWQnKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMjAwKTtcbiAgICBzaW5vbi5hc3NlcnQubm90Q2FsbGVkKGNsaWVudC5zdWJzY3JpYmUpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjY2FuY2VsQWNjb3VudH1cbiAgICovXG4gIGl0KCdzaG91bGQgY2FuY2VsIGFsbCBzdWJzY3JpcHRpb25zIGZvciBhbiBhY2NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdzdWJzY3JpYmUnKS5yZXNvbHZlcygpO1xuICAgIG1hbmFnZXIuc3Vic2NyaWJlKCdhY2NvdW50SWQnLCAwKTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkJywgMSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDEwMCk7XG4gICAgbWFuYWdlci5jYW5jZWxBY2NvdW50KCdhY2NvdW50SWQnKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoNTAwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkVHdpY2UoY2xpZW50LnN1YnNjcmliZSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNjYW5jZWxTdWJzY3JpYmV9XG4gICAqL1xuICBpdCgnc2hvdWxkIGRlc3Ryb3kgc3Vic2NyaWJlIHByb2Nlc3Mgb24gY2FuY2VsJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHN1YnNjcmliZSA9IHNhbmRib3guc3R1YigpLnJlc29sdmVzKCk7XG4gICAgY29uc3QgZGVsYXlTdWJzY3JpYmUgPSBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzdWJzY3JpYmUoKTtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgNDAwKSk7XG4gICAgfTtcbiAgICBjbGllbnQuc3Vic2NyaWJlID0gZGVsYXlTdWJzY3JpYmU7XG4gICAgbWFuYWdlci5zdWJzY3JpYmUoJ2FjY291bnRJZCcpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg1MCk7XG4gICAgbWFuYWdlci5jYW5jZWxTdWJzY3JpYmUoJ2FjY291bnRJZDowJyk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDUwKTtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkJyk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDUwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkVHdpY2Uoc3Vic2NyaWJlKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI2NhbmNlbFN1YnNjcmliZX1cbiAgICovXG4gIGl0KCdzaG91bGQgY2hlY2sgaWYgYWNjb3VudCBpcyBzdWJzY3JpYmluZycsIGFzeW5jICgpID0+IHtcbiAgICBtYW5hZ2VyLnN1YnNjcmliZSgnYWNjb3VudElkJywgMSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDUwKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2gobWFuYWdlci5pc0FjY291bnRTdWJzY3JpYmluZygnYWNjb3VudElkJyksIHRydWUpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChtYW5hZ2VyLmlzQWNjb3VudFN1YnNjcmliaW5nKCdhY2NvdW50SWQnLCAwKSwgZmFsc2UpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChtYW5hZ2VyLmlzQWNjb3VudFN1YnNjcmliaW5nKCdhY2NvdW50SWQnLCAxKSwgdHJ1ZSk7XG4gIH0pO1xuXG59KTtcbiJdfQ==