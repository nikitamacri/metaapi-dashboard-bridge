'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _logger = require('../../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Subscription manager to handle account subscription logic
 */
class SubscriptionManager {

  /**
   * Constructs the subscription manager
   * @param {MetaApiWebsocketClient} websocketClient websocket client to use for sending requests
   */
  constructor(websocketClient) {
    this._websocketClient = websocketClient;
    this._subscriptions = {};
    this._awaitingResubscribe = {};
    this._logger = _logger2.default.getLogger('SubscriptionManager');
  }

  /**
   * Returns whether an account is currently subscribing
   * @param {String} accountId account id
   * @param {Number} instanceNumber instance index number
   * @returns {Boolean} whether an account is currently subscribing
   */
  isAccountSubscribing(accountId, instanceNumber) {
    if (instanceNumber !== undefined) {
      return (0, _keys2.default)(this._subscriptions).includes(accountId + ':' + instanceNumber);
    } else {
      for (let key of (0, _keys2.default)(this._subscriptions)) {
        if (key.startsWith(accountId)) {
          return true;
        }
      }
      return false;
    }
  }

  /**
   * Returns whether an instance is in disconnected retry mode
   * @param {String} accountId account id
   * @param {Number} instanceNumber instance index number
   * @returns {Boolean} whether an account is currently subscribing
   */
  isDisconnectedRetryMode(accountId, instanceNumber) {
    let instanceId = accountId + ':' + (instanceNumber || 0);
    return this._subscriptions[instanceId] ? this._subscriptions[instanceId].isDisconnectedRetryMode : false;
  }

  /**
   * Schedules to send subscribe requests to an account until cancelled
   * @param {String} accountId id of the MetaTrader account
   * @param {Number} instanceNumber instance index number
   * @param {Boolean} isDisconnectedRetryMode whether to start subscription in disconnected retry
   * mode. Subscription task in disconnected mode will be immediately replaced when the status packet is received
   */
  async subscribe(accountId, instanceNumber, isDisconnectedRetryMode = false) {
    const client = this._websocketClient;
    let instanceId = accountId + ':' + (instanceNumber || 0);
    if (!this._subscriptions[instanceId]) {
      this._subscriptions[instanceId] = {
        shouldRetry: true,
        task: null,
        waitTask: null,
        future: null,
        isDisconnectedRetryMode
      };
      let subscribeRetryIntervalInSeconds = 3;
      while (this._subscriptions[instanceId].shouldRetry) {
        let resolveSubscribe;
        this._subscriptions[instanceId].task = { promise: new _promise2.default(res => {
            resolveSubscribe = res;
          }) };
        this._subscriptions[instanceId].task.resolve = resolveSubscribe;
        // eslint-disable-next-line no-inner-declarations
        let subscribeTask = async () => {
          try {
            await client.subscribe(accountId, instanceNumber);
          } catch (err) {
            if (err.name === 'TooManyRequestsError') {
              const socketInstanceIndex = client.socketInstancesByAccounts[accountId];
              if (err.metadata.type === 'LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_USER') {
                this._logger.error(`${instanceId}: Failed to subscribe`, err);
              }
              if (['LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_USER', 'LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_SERVER', 'LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_USER_PER_SERVER'].includes(err.metadata.type)) {
                delete client.socketInstancesByAccounts[accountId];
                client.lockSocketInstance(socketInstanceIndex, err.metadata);
              } else {
                const retryTime = new Date(err.metadata.recommendedRetryTime).getTime();
                if (Date.now() + subscribeRetryIntervalInSeconds * 1000 < retryTime) {
                  await new _promise2.default(res => setTimeout(res, retryTime - Date.now() - subscribeRetryIntervalInSeconds * 1000));
                }
              }
            }
          }
          resolveSubscribe();
        };
        subscribeTask();
        await this._subscriptions[instanceId].task.promise;
        if (!this._subscriptions[instanceId].shouldRetry) {
          break;
        }
        const retryInterval = subscribeRetryIntervalInSeconds;
        subscribeRetryIntervalInSeconds = Math.min(subscribeRetryIntervalInSeconds * 2, 300);
        let resolve;
        let subscribePromise = new _promise2.default(res => {
          resolve = res;
        });
        this._subscriptions[instanceId].waitTask = setTimeout(() => {
          resolve(true);
        }, retryInterval * 1000);
        this._subscriptions[instanceId].future = { resolve, promise: subscribePromise };
        const result = await this._subscriptions[instanceId].future.promise;
        this._subscriptions[instanceId].future = null;
        if (!result) {
          break;
        }
      }
      delete this._subscriptions[instanceId];
    }
  }

  /**
   * Cancels active subscription tasks for an instance id
   * @param {String} instanceId instance id to cancel subscription task for
   */
  cancelSubscribe(instanceId) {
    if (this._subscriptions[instanceId]) {
      const subscription = this._subscriptions[instanceId];
      if (subscription.future) {
        subscription.future.resolve(false);
        clearTimeout(subscription.waitTask);
      }
      if (subscription.task) {
        subscription.task.resolve(false);
      }
      subscription.shouldRetry = false;
    }
  }

  /**
   * Cancels active subscription tasks for an account
   * @param {String} accountId account id to cancel subscription tasks for
   */
  cancelAccount(accountId) {
    for (let instanceId of (0, _keys2.default)(this._subscriptions).filter(key => key.startsWith(accountId))) {
      this.cancelSubscribe(instanceId);
    }
  }

  /**
   * Invoked on account timeout.
   * @param {String} accountId id of the MetaTrader account
   * @param {Number} instanceNumber instance index number
   */
  onTimeout(accountId, instanceNumber) {
    if (this._websocketClient.socketInstancesByAccounts[accountId] !== undefined && this._websocketClient.connected(this._websocketClient.socketInstancesByAccounts[accountId])) {
      this.subscribe(accountId, instanceNumber, true);
    }
  }

  /**
   * Invoked when connection to MetaTrader terminal terminated
   * @param {String} accountId id of the MetaTrader account
   * @param {Number} instanceNumber instance index number
   */
  async onDisconnected(accountId, instanceNumber) {
    await new _promise2.default(res => setTimeout(res, Math.max(Math.random() * 5, 1) * 1000));
    if (this._websocketClient.socketInstancesByAccounts[accountId] !== undefined) {
      this.subscribe(accountId, instanceNumber, true);
    }
  }

  /**
   * Invoked when connection to MetaApi websocket API restored after a disconnect.
   * @param {Number} socketInstanceIndex socket instance index
   * @param {String[]} reconnectAccountIds account ids to reconnect
   */
  onReconnected(socketInstanceIndex, reconnectAccountIds) {
    try {
      const socketInstancesByAccounts = this._websocketClient.socketInstancesByAccounts;
      for (let instanceId of (0, _keys2.default)(this._subscriptions)) {
        const accountId = instanceId.split(':')[0];
        if (socketInstancesByAccounts[accountId] === socketInstanceIndex) {
          this.cancelSubscribe(instanceId);
        }
      }
      reconnectAccountIds.forEach(async accountId => {
        try {
          if (!this._awaitingResubscribe[accountId]) {
            this._awaitingResubscribe[accountId] = true;
            while (this.isAccountSubscribing(accountId)) {
              await new _promise2.default(res => setTimeout(res, 1000));
            }
            delete this._awaitingResubscribe[accountId];
            await new _promise2.default(res => setTimeout(res, Math.random() * 5000));
            this.subscribe(accountId);
          }
        } catch (err) {
          this._logger.error(`${accountId}: Account resubscribe task failed`, err);
        }
      });
    } catch (err) {
      this._logger.error('Failed to process subscribe manager reconnected event', err);
    }
  }
}
exports.default = SubscriptionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvc3Vic2NyaXB0aW9uTWFuYWdlci5lczYiXSwibmFtZXMiOlsiU3Vic2NyaXB0aW9uTWFuYWdlciIsImNvbnN0cnVjdG9yIiwid2Vic29ja2V0Q2xpZW50IiwiX3dlYnNvY2tldENsaWVudCIsIl9zdWJzY3JpcHRpb25zIiwiX2F3YWl0aW5nUmVzdWJzY3JpYmUiLCJfbG9nZ2VyIiwiTG9nZ2VyTWFuYWdlciIsImdldExvZ2dlciIsImlzQWNjb3VudFN1YnNjcmliaW5nIiwiYWNjb3VudElkIiwiaW5zdGFuY2VOdW1iZXIiLCJ1bmRlZmluZWQiLCJpbmNsdWRlcyIsImtleSIsInN0YXJ0c1dpdGgiLCJpc0Rpc2Nvbm5lY3RlZFJldHJ5TW9kZSIsImluc3RhbmNlSWQiLCJzdWJzY3JpYmUiLCJjbGllbnQiLCJzaG91bGRSZXRyeSIsInRhc2siLCJ3YWl0VGFzayIsImZ1dHVyZSIsInN1YnNjcmliZVJldHJ5SW50ZXJ2YWxJblNlY29uZHMiLCJyZXNvbHZlU3Vic2NyaWJlIiwicHJvbWlzZSIsInJlcyIsInJlc29sdmUiLCJzdWJzY3JpYmVUYXNrIiwiZXJyIiwibmFtZSIsInNvY2tldEluc3RhbmNlSW5kZXgiLCJzb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzIiwibWV0YWRhdGEiLCJ0eXBlIiwiZXJyb3IiLCJsb2NrU29ja2V0SW5zdGFuY2UiLCJyZXRyeVRpbWUiLCJEYXRlIiwicmVjb21tZW5kZWRSZXRyeVRpbWUiLCJnZXRUaW1lIiwibm93Iiwic2V0VGltZW91dCIsInJldHJ5SW50ZXJ2YWwiLCJNYXRoIiwibWluIiwic3Vic2NyaWJlUHJvbWlzZSIsInJlc3VsdCIsImNhbmNlbFN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsImNsZWFyVGltZW91dCIsImNhbmNlbEFjY291bnQiLCJmaWx0ZXIiLCJvblRpbWVvdXQiLCJjb25uZWN0ZWQiLCJvbkRpc2Nvbm5lY3RlZCIsIm1heCIsInJhbmRvbSIsIm9u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RDJDLDBCQUFvQkUsT0FBcEIsQ0FBNEIsTUFBTXBELFNBQU4sSUFBbUI7QUFDN0MsWUFBSTtBQUNGLGNBQUcsQ0FBQyxLQUFLTCxvQkFBTCxDQUEwQkssU0FBMUIsQ0FBSixFQUEwQztBQUN4QyxpQkFBS0wsb0JBQUwsQ0FBMEJLLFNBQTFCLElBQXVDLElBQXZDO0FBQ0EsbUJBQU0sS0FBS0Qsb0JBQUwsQ0FBMEJDLFNBQTFCLENBQU4sRUFBNEM7QUFDMUMsb0JBQU0sc0JBQVlpQixPQUFPZ0IsV0FBV2hCLEdBQVgsRUFBZ0IsSUFBaEIsQ0FBbkIsQ0FBTjtBQUNEO0FBQ0QsbUJBQU8sS0FBS3RCLG9CQUFMLENBQTBCSyxTQUExQixDQUFQO0FBQ0Esa0JBQU0sc0JBQVlpQixPQUFPZ0IsV0FBV2hCLEdBQVgsRUFBZ0JrQixLQUFLYSxNQUFMLEtBQWdCLElBQWhDLENBQW5CLENBQU47QUFDQSxpQkFBS3hDLFNBQUwsQ0FBZVIsU0FBZjtBQUNEO0FBQ0YsU0FWRCxDQVVFLE9BQU9vQixHQUFQLEVBQVk7QUFDWixlQUFLeEIsT0FBTCxDQUFhOEIsS0FBYixDQUFvQixHQUFFMUIsU0FBVSxtQ0FBaEMsRUFBb0VvQixHQUFwRTtBQUNEO0FBQ0YsT0FkRDtBQWVELEtBdkJELENBdUJFLE9BQU9BLEdBQVAsRUFBWTtBQUNaLFdBQUt4QixPQUFMLENBQWE4QixLQUFiLENBQW1CLHVEQUFuQixFQUE0RU4sR0FBNUU7QUFDRDtBQUNGO0FBMU1zQztrQkFBcEI5QixtQiIsImZpbGUiOiJzdWJzY3JpcHRpb25NYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgTG9nZ2VyTWFuYWdlciBmcm9tICcuLi8uLi9sb2dnZXInO1xuXG4vKipcbiAqIFN1YnNjcmlwdGlvbiBtYW5hZ2VyIHRvIGhhbmRsZSBhY2NvdW50IHN1YnNjcmlwdGlvbiBsb2dpY1xuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTdWJzY3JpcHRpb25NYW5hZ2VyIHtcblxuICAvKipcbiAgICogQ29uc3RydWN0cyB0aGUgc3Vic2NyaXB0aW9uIG1hbmFnZXJcbiAgICogQHBhcmFtIHtNZXRhQXBpV2Vic29ja2V0Q2xpZW50fSB3ZWJzb2NrZXRDbGllbnQgd2Vic29ja2V0IGNsaWVudCB0byB1c2UgZm9yIHNlbmRpbmcgcmVxdWVzdHNcbiAgICovXG4gIGNvbnN0cnVjdG9yKHdlYnNvY2tldENsaWVudCkge1xuICAgIHRoaXMuX3dlYnNvY2tldENsaWVudCA9IHdlYnNvY2tldENsaWVudDtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0ge307XG4gICAgdGhpcy5fYXdhaXRpbmdSZXN1YnNjcmliZSA9IHt9O1xuICAgIHRoaXMuX2xvZ2dlciA9IExvZ2dlck1hbmFnZXIuZ2V0TG9nZ2VyKCdTdWJzY3JpcHRpb25NYW5hZ2VyJyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB3aGV0aGVyIGFuIGFjY291bnQgaXMgY3VycmVudGx5IHN1YnNjcmliaW5nXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZFxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqIEByZXR1cm5zIHtCb29sZWFufSB3aGV0aGVyIGFuIGFjY291bnQgaXMgY3VycmVudGx5IHN1YnNjcmliaW5nXG4gICAqL1xuICBpc0FjY291bnRTdWJzY3JpYmluZyhhY2NvdW50SWQsIGluc3RhbmNlTnVtYmVyKSB7XG4gICAgaWYoaW5zdGFuY2VOdW1iZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX3N1YnNjcmlwdGlvbnMpLmluY2x1ZGVzKGFjY291bnRJZCArICc6JyArIGluc3RhbmNlTnVtYmVyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKHRoaXMuX3N1YnNjcmlwdGlvbnMpKSB7XG4gICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aChhY2NvdW50SWQpKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB3aGV0aGVyIGFuIGluc3RhbmNlIGlzIGluIGRpc2Nvbm5lY3RlZCByZXRyeSBtb2RlXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZFxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqIEByZXR1cm5zIHtCb29sZWFufSB3aGV0aGVyIGFuIGFjY291bnQgaXMgY3VycmVudGx5IHN1YnNjcmliaW5nXG4gICAqL1xuICBpc0Rpc2Nvbm5lY3RlZFJldHJ5TW9kZShhY2NvdW50SWQsIGluc3RhbmNlTnVtYmVyKSB7XG4gICAgbGV0IGluc3RhbmNlSWQgPSBhY2NvdW50SWQgKyAnOicgKyAoaW5zdGFuY2VOdW1iZXIgfHwgMCk7XG4gICAgcmV0dXJuIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0gPyB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLmlzRGlzY29ubmVjdGVkUmV0cnlNb2RlIDogZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogU2NoZWR1bGVzIHRvIHNlbmQgc3Vic2NyaWJlIHJlcXVlc3RzIHRvIGFuIGFjY291bnQgdW50aWwgY2FuY2VsbGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgaWQgb2YgdGhlIE1ldGFUcmFkZXIgYWNjb3VudFxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNEaXNjb25uZWN0ZWRSZXRyeU1vZGUgd2hldGhlciB0byBzdGFydCBzdWJzY3JpcHRpb24gaW4gZGlzY29ubmVjdGVkIHJldHJ5XG4gICAqIG1vZGUuIFN1YnNjcmlwdGlvbiB0YXNrIGluIGRpc2Nvbm5lY3RlZCBtb2RlIHdpbGwgYmUgaW1tZWRpYXRlbHkgcmVwbGFjZWQgd2hlbiB0aGUgc3RhdHVzIHBhY2tldCBpcyByZWNlaXZlZFxuICAgKi9cbiAgYXN5bmMgc3Vic2NyaWJlKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIsIGlzRGlzY29ubmVjdGVkUmV0cnlNb2RlID0gZmFsc2UpIHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLl93ZWJzb2NrZXRDbGllbnQ7XG4gICAgbGV0IGluc3RhbmNlSWQgPSBhY2NvdW50SWQgKyAnOicgKyAoaW5zdGFuY2VOdW1iZXIgfHwgMCk7XG4gICAgaWYoIXRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0pIHtcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0gPSB7XG4gICAgICAgIHNob3VsZFJldHJ5OiB0cnVlLFxuICAgICAgICB0YXNrOiBudWxsLFxuICAgICAgICB3YWl0VGFzazogbnVsbCxcbiAgICAgICAgZnV0dXJlOiBudWxsLFxuICAgICAgICBpc0Rpc2Nvbm5lY3RlZFJldHJ5TW9kZVxuICAgICAgfTtcbiAgICAgIGxldCBzdWJzY3JpYmVSZXRyeUludGVydmFsSW5TZWNvbmRzID0gMztcbiAgICAgIHdoaWxlKHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0uc2hvdWxkUmV0cnkpIHtcbiAgICAgICAgbGV0IHJlc29sdmVTdWJzY3JpYmU7XG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0udGFzayA9IHtwcm9taXNlOiBuZXcgUHJvbWlzZSgocmVzKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZVN1YnNjcmliZSA9IHJlcztcbiAgICAgICAgfSl9O1xuICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLnRhc2sucmVzb2x2ZSA9IHJlc29sdmVTdWJzY3JpYmU7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1pbm5lci1kZWNsYXJhdGlvbnNcbiAgICAgICAgbGV0IHN1YnNjcmliZVRhc2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGNsaWVudC5zdWJzY3JpYmUoYWNjb3VudElkLCBpbnN0YW5jZU51bWJlcik7XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBpZihlcnIubmFtZSA9PT0gJ1Rvb01hbnlSZXF1ZXN0c0Vycm9yJykge1xuICAgICAgICAgICAgICBjb25zdCBzb2NrZXRJbnN0YW5jZUluZGV4ID0gY2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHNbYWNjb3VudElkXTtcbiAgICAgICAgICAgICAgaWYgKGVyci5tZXRhZGF0YS50eXBlID09PSAnTElNSVRfQUNDT1VOVF9TVUJTQ1JJUFRJT05TX1BFUl9VU0VSJykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgJHtpbnN0YW5jZUlkfTogRmFpbGVkIHRvIHN1YnNjcmliZWAsIGVycik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKFsnTElNSVRfQUNDT1VOVF9TVUJTQ1JJUFRJT05TX1BFUl9VU0VSJywgJ0xJTUlUX0FDQ09VTlRfU1VCU0NSSVBUSU9OU19QRVJfU0VSVkVSJywgXG4gICAgICAgICAgICAgICAgJ0xJTUlUX0FDQ09VTlRfU1VCU0NSSVBUSU9OU19QRVJfVVNFUl9QRVJfU0VSVkVSJ10uaW5jbHVkZXMoZXJyLm1ldGFkYXRhLnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGNsaWVudC5zb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzW2FjY291bnRJZF07XG4gICAgICAgICAgICAgICAgY2xpZW50LmxvY2tTb2NrZXRJbnN0YW5jZShzb2NrZXRJbnN0YW5jZUluZGV4LCBlcnIubWV0YWRhdGEpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJldHJ5VGltZSA9IG5ldyBEYXRlKGVyci5tZXRhZGF0YS5yZWNvbW1lbmRlZFJldHJ5VGltZSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIGlmIChEYXRlLm5vdygpICsgc3Vic2NyaWJlUmV0cnlJbnRlcnZhbEluU2Vjb25kcyAqIDEwMDAgPCByZXRyeVRpbWUpIHtcbiAgICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgcmV0cnlUaW1lIC0gRGF0ZS5ub3coKSAtXG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZVJldHJ5SW50ZXJ2YWxJblNlY29uZHMgKiAxMDAwKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc29sdmVTdWJzY3JpYmUoKTtcbiAgICAgICAgfTtcbiAgICAgICAgc3Vic2NyaWJlVGFzaygpO1xuICAgICAgICBhd2FpdCB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLnRhc2sucHJvbWlzZTtcbiAgICAgICAgaWYoIXRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0uc2hvdWxkUmV0cnkpIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZXRyeUludGVydmFsID0gc3Vic2NyaWJlUmV0cnlJbnRlcnZhbEluU2Vjb25kcztcbiAgICAgICAgc3Vic2NyaWJlUmV0cnlJbnRlcnZhbEluU2Vjb25kcyA9IE1hdGgubWluKHN1YnNjcmliZVJldHJ5SW50ZXJ2YWxJblNlY29uZHMgKiAyLCAzMDApO1xuICAgICAgICBsZXQgcmVzb2x2ZTtcbiAgICAgICAgbGV0IHN1YnNjcmliZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSA9IHJlcztcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0ud2FpdFRhc2sgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9LCByZXRyeUludGVydmFsICogMTAwMCk7XG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0uZnV0dXJlID0ge3Jlc29sdmUsIHByb21pc2U6IHN1YnNjcmliZVByb21pc2V9O1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLmZ1dHVyZS5wcm9taXNlO1xuICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLmZ1dHVyZSA9IG51bGw7XG4gICAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWxzIGFjdGl2ZSBzdWJzY3JpcHRpb24gdGFza3MgZm9yIGFuIGluc3RhbmNlIGlkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUlkIGluc3RhbmNlIGlkIHRvIGNhbmNlbCBzdWJzY3JpcHRpb24gdGFzayBmb3JcbiAgICovXG4gIGNhbmNlbFN1YnNjcmliZShpbnN0YW5jZUlkKSB7XG4gICAgaWYodGhpcy5fc3Vic2NyaXB0aW9uc1tpbnN0YW5jZUlkXSkge1xuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5fc3Vic2NyaXB0aW9uc1tpbnN0YW5jZUlkXTtcbiAgICAgIGlmKHN1YnNjcmlwdGlvbi5mdXR1cmUpIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uLmZ1dHVyZS5yZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHN1YnNjcmlwdGlvbi53YWl0VGFzayk7XG4gICAgICB9XG4gICAgICBpZihzdWJzY3JpcHRpb24udGFzaykge1xuICAgICAgICBzdWJzY3JpcHRpb24udGFzay5yZXNvbHZlKGZhbHNlKTtcbiAgICAgIH1cbiAgICAgIHN1YnNjcmlwdGlvbi5zaG91bGRSZXRyeSA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWxzIGFjdGl2ZSBzdWJzY3JpcHRpb24gdGFza3MgZm9yIGFuIGFjY291bnRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkIHRvIGNhbmNlbCBzdWJzY3JpcHRpb24gdGFza3MgZm9yXG4gICAqL1xuICBjYW5jZWxBY2NvdW50KGFjY291bnRJZCkge1xuICAgIGZvcihsZXQgaW5zdGFuY2VJZCBvZiBPYmplY3Qua2V5cyh0aGlzLl9zdWJzY3JpcHRpb25zKS5maWx0ZXIoa2V5ID0+IGtleS5zdGFydHNXaXRoKGFjY291bnRJZCkpKSB7XG4gICAgICB0aGlzLmNhbmNlbFN1YnNjcmliZShpbnN0YW5jZUlkKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCBvbiBhY2NvdW50IHRpbWVvdXQuXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgaWQgb2YgdGhlIE1ldGFUcmFkZXIgYWNjb3VudFxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqL1xuICBvblRpbWVvdXQoYWNjb3VudElkLCBpbnN0YW5jZU51bWJlcikge1xuICAgIGlmKHRoaXMuX3dlYnNvY2tldENsaWVudC5zb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzW2FjY291bnRJZF0gIT09IHVuZGVmaW5lZCAmJiBcbiAgICAgIHRoaXMuX3dlYnNvY2tldENsaWVudC5jb25uZWN0ZWQodGhpcy5fd2Vic29ja2V0Q2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHNbYWNjb3VudElkXSkpIHtcbiAgICAgIHRoaXMuc3Vic2NyaWJlKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIsIHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gY29ubmVjdGlvbiB0byBNZXRhVHJhZGVyIHRlcm1pbmFsIHRlcm1pbmF0ZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBpZCBvZiB0aGUgTWV0YVRyYWRlciBhY2NvdW50XG4gICAqIEBwYXJhbSB7TnVtYmVyfSBpbnN0YW5jZU51bWJlciBpbnN0YW5jZSBpbmRleCBudW1iZXJcbiAgICovXG4gIGFzeW5jIG9uRGlzY29ubmVjdGVkKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIpIHtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIE1hdGgubWF4KE1hdGgucmFuZG9tKCkgKiA1LCAxKSAqIDEwMDApKTtcbiAgICBpZih0aGlzLl93ZWJzb2NrZXRDbGllbnQuc29ja2V0SW5zdGFuY2VzQnlBY2NvdW50c1thY2NvdW50SWRdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuc3Vic2NyaWJlKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIsIHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gY29ubmVjdGlvbiB0byBNZXRhQXBpIHdlYnNvY2tldCBBUEkgcmVzdG9yZWQgYWZ0ZXIgYSBkaXNjb25uZWN0LlxuICAgKiBAcGFyYW0ge051bWJlcn0gc29ja2V0SW5zdGFuY2VJbmRleCBzb2NrZXQgaW5zdGFuY2UgaW5kZXhcbiAgICogQHBhcmFtIHtTdHJpbmdbXX0gcmVjb25uZWN0QWNjb3VudElkcyBhY2NvdW50IGlkcyB0byByZWNvbm5lY3RcbiAgICovXG4gIG9uUmVjb25uZWN0ZWQoc29ja2V0SW5zdGFuY2VJbmRleCwgcmVjb25uZWN0QWNjb3VudElkcykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzID0gdGhpcy5fd2Vic29ja2V0Q2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHM7XG4gICAgICBmb3IobGV0IGluc3RhbmNlSWQgb2YgT2JqZWN0LmtleXModGhpcy5fc3Vic2NyaXB0aW9ucykpe1xuICAgICAgICBjb25zdCBhY2NvdW50SWQgPSBpbnN0YW5jZUlkLnNwbGl0KCc6JylbMF07XG4gICAgICAgIGlmIChzb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzW2FjY291bnRJZF0gPT09IHNvY2tldEluc3RhbmNlSW5kZXgpIHtcbiAgICAgICAgICB0aGlzLmNhbmNlbFN1YnNjcmliZShpbnN0YW5jZUlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmVjb25uZWN0QWNjb3VudElkcy5mb3JFYWNoKGFzeW5jIGFjY291bnRJZCA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaWYoIXRoaXMuX2F3YWl0aW5nUmVzdWJzY3JpYmVbYWNjb3VudElkXSkge1xuICAgICAgICAgICAgdGhpcy5fYXdhaXRpbmdSZXN1YnNjcmliZVthY2NvdW50SWRdID0gdHJ1ZTtcbiAgICAgICAgICAgIHdoaWxlKHRoaXMuaXNBY2NvdW50U3Vic2NyaWJpbmcoYWNjb3VudElkKSkge1xuICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDEwMDApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9hd2FpdGluZ1Jlc3Vic2NyaWJlW2FjY291bnRJZF07XG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIE1hdGgucmFuZG9tKCkgKiA1MDAwKSk7XG4gICAgICAgICAgICB0aGlzLnN1YnNjcmliZShhY2NvdW50SWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGAke2FjY291bnRJZH06IEFjY291bnQgcmVzdWJzY3JpYmUgdGFzayBmYWlsZWRgLCBlcnIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcignRmFpbGVkIHRvIHByb2Nlc3Mgc3Vic2NyaWJlIG1hbmFnZXIgcmVjb25uZWN0ZWQgZXZlbnQnLCBlcnIpO1xuICAgIH1cbiAgfVxufSJdfQ==