'use strict';

var _is = require('babel-runtime/core-js/object/is');

var _is2 = _interopRequireDefault(_is);

var _should = require('should');

var _should2 = _interopRequireDefault(_should);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _metaApiConnection = require('./metaApiConnection');

var _metaApiConnection2 = _interopRequireDefault(_metaApiConnection);

var _connectionRegistry = require('./connectionRegistry');

var _connectionRegistry2 = _interopRequireDefault(_connectionRegistry);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {ConnectionRegistry}
 */
describe('ConnectionRegistry', () => {

  let sandbox;
  let registry;
  let metaApiWebsocketClient = {
    addSynchronizationListener: () => {},
    addReconnectListener: () => {},
    subscribe: () => {}
  };
  let storage = {
    lastHistoryOrderTime: () => new Date('2020-01-01T00:00:00.000Z'),
    lastDealTime: () => new Date('2020-01-02T00:00:00.000Z'),
    loadDataFromDisk: () => ({ deals: [], historyOrders: [] })
  };

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    registry = new _connectionRegistry2.default(metaApiWebsocketClient);
    sandbox.stub(_metaApiConnection2.default.prototype, 'initialize').resolves();
    sandbox.stub(_metaApiConnection2.default.prototype, 'subscribe').resolves();
  });

  afterEach(() => {
    sandbox.restore();
  });

  /**
   * @test {ConnectionRegistry#connect}
   */
  it('should connect and add connection to registry', async () => {
    let account = { id: 'id' };
    let connection = await registry.connect(account, storage);
    (connection instanceof _metaApiConnection2.default).should.be.true();
    connection.historyStorage.should.equal(storage);
    _sinon2.default.assert.calledOnce(connection.initialize);
    _sinon2.default.assert.calledOnce(connection.subscribe);
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id', connection));
  });

  /**
   * @test {ConnectionRegistry#connect}
   */
  it('should return the same connection on second connect if same account id', async () => {
    let accounts = [{ id: 'id0' }, { id: 'id1' }];
    let connection0 = await registry.connect(accounts[0], storage);
    let connection02 = await registry.connect(accounts[0], storage);
    let connection1 = await registry.connect(accounts[1], storage);
    _sinon2.default.assert.called(connection0.initialize);
    _sinon2.default.assert.called(connection0.subscribe);
    _sinon2.default.assert.called(connection1.initialize);
    _sinon2.default.assert.called(connection1.subscribe);
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id0', connection0));
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id1', connection1));
    _sinon2.default.assert.match((0, _is2.default)(connection0, connection02), true);
    _sinon2.default.assert.match((0, _is2.default)(connection0, connection1), false);
  });

  /**
   * @test {ConnectionRegistry#remove}
   */
  it('should remove the account from registry', async () => {
    let accounts = [{ id: 'id0' }, { id: 'id1' }];
    let connection0 = await registry.connect(accounts[0], storage);
    let connection1 = await registry.connect(accounts[1], storage);
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id0', connection0));
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id1', connection1));
    registry.remove(accounts[0].id);
    _sinon2.default.assert.match(registry._connections.id0, undefined);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL2Nvbm5lY3Rpb25SZWdpc3RyeS5zcGVjLmVzNiJdLCJuYW1lcyI6WyJkZXNjcmliZSIsInNhbmRib3giLCJyZWdpc3RyeSIsIm1ldGFBcGlXZWJzb2NrZXRDbGllbnQiLCJhZGRTeW5jaHJvbml6YXRpb25MaXN0ZW5lciIsImFkZFJlY29ubmVjdExpc3RlbmVyIiwic3Vic2NyaWJlIiwic3RvcmFnZSIsImxhc3RIaXN0b3J5T3JkZXJUaW1lIiwiRGF0ZSIsImxhc3REZWFsVGltZSIsImxvYWREYXRhRnJvbURpc2siLCJkZWFscyIsImhpc3RvcnlPcmRlcnMiLCJiZWZvcmUiLCJzaW5vbiIsImNyZWF0ZVNhbmRib3giLCJiZWZvcmVFYWNoIiwiQ29ubmVjdGlvblJlZ2lzdHJ5Iiwic3R1YiIsIk1ldGFBcGlDb25uZWN0aW9uIiwicHJvdG90eXBlIiwicmVzb2x2ZXMiLCJhZnRlckVhY2giLCJyZXN0b3JlIiwiaXQiLCJhY2NvdW50IiwiaWQiLCJjb25uZWN0aW9uIiwiY29ubmVjdCIsInNob3VsZCIsImJlIiwidHJ1ZSIsImhpc3RvcnlTdG9yYWdlIiwiZXF1YWwiLCJhc3NlcnQiLCJjYWxsZWRPbmNlIiwiaW5pdGlhbGl6ZSIsIm1hdGNoIiwiX2Nvbm5lY3Rpb25zIiwiaGFzIiwiYWNjb3VudHMiLCJjb25uZWN0aW9uMCIsImNvbm5lY3Rpb24wMiIsImNvbm5lY3Rpb24xIiwiY2FsbGVkIiwicmVtb3ZlIiwiaWQwIiwidW5kZWZpbmVkIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBOzs7QUFHQUEsU0FBUyxvQkFBVCxFQUErQixNQUFNOztBQUVuQyxNQUFJQyxPQUFKO0FBQ0EsTUFBSUMsUUFBSjtBQUNBLE1BQUlDLHlCQUF5QjtBQUMzQkMsZ0NBQTRCLE1BQU0sQ0FBRSxDQURUO0FBRTNCQywwQkFBc0IsTUFBTSxDQUFFLENBRkg7QUFHM0JDLGVBQVcsTUFB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QVYsRUFBdUJDLFlBQXZCLENBQW5CLEVBQXlELElBQXpEO0FBQ0E1QixvQkFBTW9CLE1BQU4sQ0FBYUcsS0FBYixDQUFtQixrQkFBVUksV0FBVixFQUF1QkUsV0FBdkIsQ0FBbkIsRUFBd0QsS0FBeEQ7QUFDRCxHQWJEOztBQWVBOzs7QUFHQW5CLEtBQUcseUNBQUgsRUFBOEMsWUFBWTtBQUN4RCxRQUFJZ0IsV0FBVyxDQUFDLEVBQUNkLElBQUksS0FBTCxFQUFELEVBQWMsRUFBQ0EsSUFBSSxLQUFMLEVBQWQsQ0FBZjtBQUNBLFFBQUllLGNBQWMsTUFBTXhDLFNBQVMyQixPQUFULENBQWlCWSxTQUFTLENBQVQsQ0FBakIsRUFBOEJsQyxPQUE5QixDQUF4QjtBQUNBLFFBQUlxQyxjQUFjLE1BQU0xQyxTQUFTMkIsT0FBVCxDQUFpQlksU0FBUyxDQUFULENBQWpCLEVBQThCbEMsT0FBOUIsQ0FBeEI7QUFDQVEsb0JBQU1vQixNQUFOLENBQWFHLEtBQWIsQ0FBbUJwQyxTQUFTcUMsWUFBNUIsRUFBMEN4QixnQkFBTXVCLEtBQU4sQ0FBWUUsR0FBWixDQUFnQixLQUFoQixFQUF1QkUsV0FBdkIsQ0FBMUM7QUFDQTNCLG9CQUFNb0IsTUFBTixDQUFhRyxLQUFiLENBQW1CcEMsU0FBU3FDLFlBQTVCLEVBQTBDeEIsZ0JBQU11QixLQUFOLENBQVlFLEdBQVosQ0FBZ0IsS0FBaEIsRUFBdUJJLFdBQXZCLENBQTFDO0FBQ0ExQyxhQUFTNEMsTUFBVCxDQUFnQkwsU0FBUyxDQUFULEVBQVlkLEVBQTVCO0FBQ0FaLG9CQUFNb0IsTUFBTixDQUFhRyxLQUFiLENBQW1CcEMsU0FBU3FDLFlBQVQsQ0FBc0JRLEdBQXpDLEVBQThDQyxTQUE5QztBQUNELEdBUkQ7QUFVRCxDQXpFRCIsImZpbGUiOiJjb25uZWN0aW9uUmVnaXN0cnkuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHNob3VsZCBmcm9tICdzaG91bGQnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBNZXRhQXBpQ29ubmVjdGlvbiBmcm9tICcuL21ldGFBcGlDb25uZWN0aW9uJztcbmltcG9ydCBDb25uZWN0aW9uUmVnaXN0cnkgZnJvbSAnLi9jb25uZWN0aW9uUmVnaXN0cnknO1xuXG4vKipcbiAqIEB0ZXN0IHtDb25uZWN0aW9uUmVnaXN0cnl9XG4gKi9cbmRlc2NyaWJlKCdDb25uZWN0aW9uUmVnaXN0cnknLCAoKSA9PiB7XG5cbiAgbGV0IHNhbmRib3g7XG4gIGxldCByZWdpc3RyeTtcbiAgbGV0IG1ldGFBcGlXZWJzb2NrZXRDbGllbnQgPSB7XG4gICAgYWRkU3luY2hyb25pemF0aW9uTGlzdGVuZXI6ICgpID0+IHt9LFxuICAgIGFkZFJlY29ubmVjdExpc3RlbmVyOiAoKSA9PiB7fSxcbiAgICBzdWJzY3JpYmU6ICgpID0+IHt9XG4gIH07XG4gIGxldCBzdG9yYWdlID0ge1xuICAgIGxhc3RIaXN0b3J5T3JkZXJUaW1lOiAoKSA9PiBuZXcgRGF0ZSgnMjAyMC0wMS0wMVQwMDowMDowMC4wMDBaJyksXG4gICAgbGFzdERlYWxUaW1lOiAoKSA9PiBuZXcgRGF0ZSgnMjAyMC0wMS0wMlQwMDowMDowMC4wMDBaJyksXG4gICAgbG9hZERhdGFGcm9tRGlzazogKCkgPT4gKHtkZWFsczogW10sIGhpc3RvcnlPcmRlcnM6IFtdfSlcbiAgfTtcblxuICBiZWZvcmUoKCkgPT4ge1xuICAgIHNhbmRib3ggPSBzaW5vbi5jcmVhdGVTYW5kYm94KCk7XG4gIH0pO1xuICBcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgcmVnaXN0cnkgPSBuZXcgQ29ubmVjdGlvblJlZ2lzdHJ5KG1ldGFBcGlXZWJzb2NrZXRDbGllbnQpO1xuICAgIHNhbmRib3guc3R1YihNZXRhQXBpQ29ubmVjdGlvbi5wcm90b3R5cGUsICdpbml0aWFsaXplJykucmVzb2x2ZXMoKTtcbiAgICBzYW5kYm94LnN0dWIoTWV0YUFwaUNvbm5lY3Rpb24ucHJvdG90eXBlLCAnc3Vic2NyaWJlJykucmVzb2x2ZXMoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBzYW5kYm94LnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtDb25uZWN0aW9uUmVnaXN0cnkjY29ubmVjdH1cbiAgICovXG4gIGl0KCdzaG91bGQgY29ubmVjdCBhbmQgYWRkIGNvbm5lY3Rpb24gdG8gcmVnaXN0cnknLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGFjY291bnQgPSB7aWQ6ICdpZCd9O1xuICAgIGxldCBjb25uZWN0aW9uID0gYXdhaXQgcmVnaXN0cnkuY29ubmVjdChhY2NvdW50LCBzdG9yYWdlKTtcbiAgICAoY29ubmVjdGlvbiBpbnN0YW5jZW9mIE1ldGFBcGlDb25uZWN0aW9uKS5zaG91bGQuYmUudHJ1ZSgpO1xuICAgIGNvbm5lY3Rpb24uaGlzdG9yeVN0b3JhZ2Uuc2hvdWxkLmVxdWFsKHN0b3JhZ2UpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRPbmNlKGNvbm5lY3Rpb24uaW5pdGlhbGl6ZSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UoY29ubmVjdGlvbi5zdWJzY3JpYmUpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChyZWdpc3RyeS5fY29ubmVjdGlvbnMsIHNpbm9uLm1hdGNoLmhhcygnaWQnLCBjb25uZWN0aW9uKSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7Q29ubmVjdGlvblJlZ2lzdHJ5I2Nvbm5lY3R9XG4gICAqL1xuICBpdCgnc2hvdWxkIHJldHVybiB0aGUgc2FtZSBjb25uZWN0aW9uIG9uIHNlY29uZCBjb25uZWN0IGlmIHNhbWUgYWNjb3VudCBpZCcsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgYWNjb3VudHMgPSBbe2lkOiAnaWQwJ30sIHtpZDogJ2lkMSd9XTtcbiAgICBsZXQgY29ubmVjdGlvbjAgPSBhd2FpdCByZWdpc3RyeS5jb25uZWN0KGFjY291bnRzWzBdLCBzdG9yYWdlKTtcbiAgICBsZXQgY29ubmVjdGlvbjAyID0gYXdhaXQgcmVnaXN0cnkuY29ubmVjdChhY2NvdW50c1swXSwgc3RvcmFnZSk7XG4gICAgbGV0IGNvbm5lY3Rpb24xID0gYXdhaXQgcmVnaXN0cnkuY29ubmVjdChhY2NvdW50c1sxXSwgc3RvcmFnZSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZChjb25uZWN0aW9uMC5pbml0aWFsaXplKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkKGNvbm5lY3Rpb24wLnN1YnNjcmliZSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZChjb25uZWN0aW9uMS5pbml0aWFsaXplKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkKGNvbm5lY3Rpb24xLnN1YnNjcmliZSk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlZ2lzdHJ5Ll9jb25uZWN0aW9ucywgc2lub24ubWF0Y2guaGFzKCdpZDAnLCBjb25uZWN0aW9uMCkpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChyZWdpc3RyeS5fY29ubmVjdGlvbnMsIHNpbm9uLm1hdGNoLmhhcygnaWQxJywgY29ubmVjdGlvbjEpKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goT2JqZWN0LmlzKGNvbm5lY3Rpb24wLCBjb25uZWN0aW9uMDIpLCB0cnVlKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goT2JqZWN0LmlzKGNvbm5lY3Rpb24wLCBjb25uZWN0aW9uMSksIGZhbHNlKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtDb25uZWN0aW9uUmVnaXN0cnkjcmVtb3ZlfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZW1vdmUgdGhlIGFjY291bnQgZnJvbSByZWdpc3RyeScsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgYWNjb3VudHMgPSBbe2lkOiAnaWQwJ30sIHtpZDogJ2lkMSd9XTtcbiAgICBsZXQgY29ubmVjdGlvbjAgPSBhd2FpdCByZWdpc3RyeS5jb25uZWN0KGFjY291bnRzWzBdLCBzdG9yYWdlKTtcbiAgICBsZXQgY29ubmVjdGlvbjEgPSBhd2FpdCByZWdpc3RyeS5jb25uZWN0KGFjY291bnRzWzFdLCBzdG9yYWdlKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2gocmVnaXN0cnkuX2Nvbm5lY3Rpb25zLCBzaW5vbi5tYXRjaC5oYXMoJ2lkMCcsIGNvbm5lY3Rpb24wKSk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlZ2lzdHJ5Ll9jb25uZWN0aW9ucywgc2lub24ubWF0Y2guaGFzKCdpZDEnLCBjb25uZWN0aW9uMSkpO1xuICAgIHJlZ2lzdHJ5LnJlbW92ZShhY2NvdW50c1swXS5pZCk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlZ2lzdHJ5Ll9jb25uZWN0aW9ucy5pZDAsIHVuZGVmaW5lZCk7XG4gIH0pO1xuXG59KTtcbiJdfQ==