/* jscs:disable */
/* eslint-disable */

'use strict';

function createNewNode_(key) {
  return {
    key: key,
    weight: 1,
    height: 0,
    left: null,
    right: null
  };
}

var comparer_ = function (a, b) {
  if (a < b) return -1;
  if (a > b) return 1;
  return 0;
};

function height_(p) {
  return p ? p.height : 0;
}

function weight_(p) {
  return p ? p.weight : 0;
}

function bFactor_(p) {
  return height_(p.right) - height_(p.left);
}

function countHeightAndWeight_(p) {
  var hl = height_(p.left);
  var hr = height_(p.right);
  p.height = (hl > hr ? hl : hr) + 1;

  var wl = weight_(p.left);
  var wr = weight_(p.right);
  p.weight = wl + wr + 1;
}

function rotateRight_(p) {
  var q = p.left;
  p.left = q.right;
  q.right = p;
  countHeightAndWeight_(p);
  countHeightAndWeight_(q);
  return q;
}

function rotateLeft_(q) {
  var p = q.right;
  q.right = p.left;
  p.left = q;
  countHeightAndWeight_(q);
  countHeightAndWeight_(p);
  return p;
}

function balance_(p) {
  countHeightAndWeight_(p);
  if (bFactor_(p) === 2) {
    if (bFactor_(p.right) < 0) p.right = rotateRight_(p.right);
    return rotateLeft_(p);
  }
  if (bFactor_(p) === -2) {
    if (bFactor_(p.left) > 0) p.left = rotateLeft_(p.left);
    return rotateRight_(p);
  }
  return p;
}

function count_(p, k) {
  return upperBound_(p, k) - lowerBound_(p, k);
}

function at_(p, k) {
  if (!p) return null;
  var wl = weight_(p.left);
  if (wl <= k && k < wl + 1) return p.key;else if (k < wl) return at_(p.left, k);else return at_(p.right, k - wl - 1);
}

function getMinimum_(p) {
  if (!p) return null;
  return p.left ? getMinimum_(p.left) : p;
}

function getMaximum_(p) {
  if (!p) return null;
  return p.right ? getMaximum_(p.right) : p;
}

function removeMinimun_(p) {
  if (!p.left) return p.right;
  p.left = removeMinimun_(p.left);
  return balance_(p);
}

function toArray_(p) {
  var arr = [];
  if (p.left) arr = arr.concat(toArray_(p.left));
  arr.push(p.key);
  if (p.right) arr = arr.concat(toArray_(p.right));
  return arr;
}

function toValueArray_(p) {
  var arr = [];
  if (p.left) arr = arr.concat(toArray_(p.left));
  arr.push(p.key.data);
  if (p.right) arr = arr.concat(toArray_(p.right));
  return arr;
}

var AVLTree = function (comparer) {
  if (!comparer) comparer = comparer_;
  var AVL = {
    root: null,
    comparer_: comparer,

    size: function () {
      return weight_(AVL.root);
    },

    min: function () {
      var p = getMinimum_(AVL.root);
      if (p) return p.key;
      return null;
    },

    max: function () {
      var p = getMaximum_(AVL.root);
      if (p) return p.key;
      return null;
    },

    lowerBound: function (k) {
      return AVL.lowerBound_(AVL.root, k);
    },
    lowerBound_(p, k) {
      if (!p) return 0;
      var cmp = AVL.comparer_(k, p.key);

      if (cmp <= 0) return AVL.lowerBound_(p.left, k);else if (cmp > 0) return weight_(p.left) + AVL.lowerBound_(p.right, k) + 1;
    },

    upperBound: function (k) {
      return AVL.upperBound_(AVL.root, k);
    },

    upperBound_(p, k) {
      if (!p) return 0;
      var cmp = AVL.comparer_(k, p.key);

      if (cmp < 0) return AVL.upperBound_(p.left, k);else if (cmp >= 0) return weight_(p.left) + AVL.upperBound_(p.right, k) + 1;
    },

    count: function (k) {
      return count_(AVL.root, k);
    },

    at: function (k) {
      return at_(AVL.root, k);
    },

    insert: function (k) {
      AVL.root = AVL.insert_(AVL.root, k);
    },

    insert_(p, k) {
      if (!p) return createNewNode_(k);
      var cmp = AVL.comparer_(k, p.key);

      if (cmp < 0) p.left = AVL.insert_(p.left, k);else if (cmp >= 0) p.right = AVL.insert_(p.right, k);
      return balance_(p);
    },

    remove: function (k) {
      AVL.root = AVL.remove_(AVL.root, k);
    },

    remove_(p, k) {
      if (!p) return null;
      var cmp = AVL.comparer_(k, p.key);

      if (cmp < 0) p.left = AVL.remove_(p.left, k);else if (cmp > 0) p.right = AVL.remove_(p.right, k);else {
        var q = p.left;
        var r = p.right;
        if (!r) return q;

        var min = getMinimum_(r);
        min.right = removeMinimun_(r);
        min.left = q;
        return balance_(min);
      }
      return balance_(p);
    },

    removeAt: function (k) {
      var val = AVL.at(k);
      AVL.root = AVL.remove_(AVL.root, val);
    },

    toArray: function () {
      if (AVL.root === null) return [];
      return toArray_(AVL.root);
    }
  };
  return AVL;
};

module.exports = AVLTree;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9tZXRhQXBpL3Jlc2Vydm9pci9hdmxUcmVlLmVzNiJdLCJuYW1lcyI6WyJjcmVhdGVOZXdOb2RlXyIsImtleSIsIndlaWdodCIsImhlaWdodCIsImxlZnQiLCJyaWdodCIsImNvbXBhcmVyXyIsImEiLCJiIiwiaGVpZ2h0XyIsInAiLCJ3ZWlnaHRfIiwiYkZhY3Rvcl8iLCJjb3VudEhlaWdodEFuZFdlaWdodF8iLCJobCIsImhyIiwid2wiLCJ3ciIsInJvdGF0ZVJpZ2h0XyIsInEiLCJyb3RhdGVMZWZ0XyIsImJhbGFuY2VfIiwiY291bnRfIiwiayIsInVwcGVyQm91bmRfIiwibG93ZXJCb3VuZF8iLCJhdF8iLCJnZXRNaW5pbXVtXyIsImdldE1heGltdW1fIiwicmVtb3ZlTWluaW11bl8iLCJ0b0FycmF5XyIsImFyciIsImNvbmNhdCIsInB1c2giLCJ0b1ZhbHVlQXJyYXlfIiwiZGF0YSIsIkFWTFRyZWUiLCJjb21wYXJlciIsIkFWTCIsInJvb3QiLCJzaXplIiwibWluIiwibWF4IiwibG93ZXJCb3VuZCIsImNtcCIsInVwcGVyQm91bmQiLCJjb3VudCIsImF0IiwiaW5zZXJ0IiwiaW5zZXJ0XyIsInJlbW92ZSIsInJlbW92ZV8iLCJyIiwicmVtb3ZlQXQiLCJ2YWwiLCJ0b0FycmF5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTs7QUFFQTs7QUFFQSxTQUFTQSxjQUFULENBQXdCQyxHQUF4QixFQUE2QjtBQUMzQixTQUFPO0FBQ0xBLFNBQUtBLEdBREE7QUFFTEMsWUFBUSxDQUZIO0FBR0xDLFlBQVEsQ0FISDtBQUlMQyxVQUFNLElBSkQ7QUFLTEMsV0FBTztBQUxGLEdBQVA7QUFPRDs7QUFFRCxJQUFJQyxZQUFZLFVBQVNDLENBQVQsRUFBWUMsQ0FBWixFQUFlO0FBQzdCLE1BQUlELElBQUlDLENBQVIsRUFBVyxPQUFPLENBQUMsQ0FBUjtBQUNYLE1BQUlELElBQUlDLENBQVIsRUFBVyxPQUFPLENB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QUVOLElBQVY7QUFDQSxZQUFJZ0QsSUFBSTFDLEVBQUVMLEtBQVY7QUFDQSxZQUFJLENBQUMrQyxDQUFMLEVBQVEsT0FBT2pDLENBQVA7O0FBRVIsWUFBSXNCLE1BQU1kLFlBQVl5QixDQUFaLENBQVY7QUFDQVgsWUFBSXBDLEtBQUosR0FBWXdCLGVBQWV1QixDQUFmLENBQVo7QUFDQVgsWUFBSXJDLElBQUosR0FBV2UsQ0FBWDtBQUNBLGVBQU9FLFNBQVNvQixHQUFULENBQVA7QUFDRDtBQUNELGFBQU9wQixTQUFTWCxDQUFULENBQVA7QUFDRCxLQXJGTzs7QUF1RlIyQyxjQUFVLFVBQVM5QixDQUFULEVBQVk7QUFDcEIsVUFBSStCLE1BQU1oQixJQUFJUyxFQUFKLENBQU94QixDQUFQLENBQVY7QUFDQWUsVUFBSUMsSUFBSixHQUFXRCxJQUFJYSxPQUFKLENBQVliLElBQUlDLElBQWhCLEVBQXNCZSxHQUF0QixDQUFYO0FBQ0QsS0ExRk87O0FBNEZSQyxhQUFTLFlBQVc7QUFDbEIsVUFBSWpCLElBQUlDLElBQUosS0FBYSxJQUFqQixFQUF1QixPQUFPLEVBQVA7QUFDdkIsYUFBT1QsU0FBU1EsSUFBSUMsSUFBYixDQUFQO0FBQ0Q7QUEvRk8sR0FBVjtBQWlHQSxTQUFPRCxHQUFQO0FBQ0QsQ0FwR0Q7O0FBc0dBa0IsT0FBT0MsT0FBUCxHQUFpQnJCLE9BQWpCIiwiZmlsZSI6ImF2bFRyZWUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBqc2NzOmRpc2FibGUgKi9cbi8qIGVzbGludC1kaXNhYmxlICovXG5cbid1c2Ugc3RyaWN0JztcblxuZnVuY3Rpb24gY3JlYXRlTmV3Tm9kZV8oa2V5KSB7XG4gIHJldHVybiB7XG4gICAga2V5OiBrZXksXG4gICAgd2VpZ2h0OiAxLFxuICAgIGhlaWdodDogMCxcbiAgICBsZWZ0OiBudWxsLFxuICAgIHJpZ2h0OiBudWxsXG4gIH07XG59XG5cbnZhciBjb21wYXJlcl8gPSBmdW5jdGlvbihhLCBiKSB7XG4gIGlmIChhIDwgYikgcmV0dXJuIC0xO1xuICBpZiAoYSA+IGIpIHJldHVybiAxO1xuICByZXR1cm4gMDtcbn1cblxuZnVuY3Rpb24gaGVpZ2h0XyhwKSB7XG4gIHJldHVybiBwID8gcC5oZWlnaHQgOiAwO1xufVxuXG5mdW5jdGlvbiB3ZWlnaHRfKHApIHtcbiAgcmV0dXJuIHAgPyBwLndlaWdodCA6IDA7XG59XG5cbmZ1bmN0aW9uIGJGYWN0b3JfKHApIHtcbiAgcmV0dXJuIGhlaWdodF8ocC5yaWdodCkgLSBoZWlnaHRfKHAubGVmdCk7XG59XG5cbmZ1bmN0aW9uIGNvdW50SGVpZ2h0QW5kV2VpZ2h0XyhwKSB7XG4gIHZhciBobCA9IGhlaWdodF8ocC5sZWZ0KTtcbiAgdmFyIGhyID0gaGVpZ2h0XyhwLnJpZ2h0KTtcbiAgcC5oZWlnaHQgPSAoaGwgPiBociA/IGhsIDogaHIpICsgMTtcblxuICB2YXIgd2wgPSB3ZWlnaHRfKHAubGVmdCk7XG4gIHZhciB3ciA9IHdlaWdodF8ocC5yaWdodCk7XG4gIHAud2VpZ2h0ID0gd2wgKyB3ciArIDE7XG59XG5cbmZ1bmN0aW9uIHJvdGF0ZVJpZ2h0XyhwKSB7XG4gIHZhciBxID0gcC5sZWZ0O1xuICBwLmxlZnQgPSBxLnJpZ2h0O1xuICBxLnJpZ2h0ID0gcDtcbiAgY291bnRIZWlnaHRBbmRXZWlnaHRfKHApO1xuICBjb3VudEhlaWdodEFuZFdlaWdodF8ocSk7XG4gIHJldHVybiBxO1xufVxuXG5mdW5jdGlvbiByb3RhdGVMZWZ0XyhxKSB7XG4gIHZhciBwID0gcS5yaWdodDtcbiAgcS5yaWdodCA9IHAubGVmdDtcbiAgcC5sZWZ0ID0gcTtcbiAgY291bnRIZWlnaHRBbmRXZWlnaHRfKHEpO1xuICBjb3VudEhlaWdodEFuZFdlaWdodF8ocCk7XG4gIHJldHVybiBwO1xufVxuXG5mdW5jdGlvbiBiYWxhbmNlXyhwKSB7XG4gIGNvdW50SGVpZ2h0QW5kV2VpZ2h0XyhwKTtcbiAgaWYgKGJGYWN0b3JfKHApID09PSAyKSB7XG4gICAgaWYgKGJGYWN0b3JfKHAucmlnaHQpIDwgMClcbiAgICAgIHAucmlnaHQgPSByb3RhdGVSaWdodF8ocC5yaWdodCk7XG4gICAgcmV0dXJuIHJvdGF0ZUxlZnRfKHApO1xuICB9XG4gIGlmIChiRmFjdG9yXyhwKSA9PT0gLTIpIHtcbiAgICBpZiAoYkZhY3Rvcl8ocC5sZWZ0KSA+IDApXG4gICAgICBwLmxlZnQgPSByb3RhdGVMZWZ0XyhwLmxlZnQpO1xuICAgIHJldHVybiByb3RhdGVSaWdodF8ocCk7XG4gIH1cbiAgcmV0dXJuIHA7XG59XG5cbmZ1bmN0aW9uIGNvdW50XyhwLCBrKSB7XG4gIHJldHVybiB1cHBlckJvdW5kXyhwLCBrKSAtIGxvd2VyQm91bmRfKHAsIGspO1xufVxuXG5mdW5jdGlvbiBhdF8ocCwgaykge1xuICBpZiAoIXApIHJldHVybiBudWxsO1xuICB2YXIgd2wgPSB3ZWlnaHRfKHAubGVmdCk7XG4gIGlmICh3bCA8PSBrICYmIGsgPCB3bCArIDEpIHJldHVybiBwLmtleTtcbiAgZWxzZSBpZiAoayA8IHdsKSByZXR1cm4gYXRfKHAubGVmdCwgayk7XG4gIGVsc2UgcmV0dXJuIGF0XyhwLnJpZ2h0LCBrIC0gd2wgLSAxKTtcbn1cblxuZnVuY3Rpb24gZ2V0TWluaW11bV8ocCkge1xuICBpZiAoIXApIHJldHVybiBudWxsO1xuICByZXR1cm4gcC5sZWZ0ID8gZ2V0TWluaW11bV8ocC5sZWZ0KSA6IHA7XG59XG5cbmZ1bmN0aW9uIGdldE1heGltdW1fKHApIHtcbiAgaWYgKCFwKSByZXR1cm4gbnVsbDtcbiAgcmV0dXJuIHAucmlnaHQgPyBnZXRNYXhpbXVtXyhwLnJpZ2h0KSA6IHA7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZU1pbmltdW5fKHApIHtcbiAgaWYgKCFwLmxlZnQpIHJldHVybiBwLnJpZ2h0O1xuICBwLmxlZnQgPSByZW1vdmVNaW5pbXVuXyhwLmxlZnQpO1xuICByZXR1cm4gYmFsYW5jZV8ocCk7XG59XG5cbmZ1bmN0aW9uIHRvQXJyYXlfKHApIHtcbiAgdmFyIGFyciA9IFtdO1xuICBpZiAocC5sZWZ0KSBhcnIgPSBhcnIuY29uY2F0KHRvQXJyYXlfKHAubGVmdCkpO1xuICBhcnIucHVzaChwLmtleSk7XG4gIGlmIChwLnJpZ2h0KSBhcnIgPSBhcnIuY29uY2F0KHRvQXJyYXlfKHAucmlnaHQpKTtcbiAgcmV0dXJuIGFycjtcbn1cblxuZnVuY3Rpb24gdG9WYWx1ZUFycmF5XyhwKSB7XG4gIHZhciBhcnIgPSBbXTtcbiAgaWYgKHAubGVmdCkgYXJyID0gYXJyLmNvbmNhdCh0b0FycmF5XyhwLmxlZnQpKTtcbiAgYXJyLnB1c2gocC5rZXkuZGF0YSk7XG4gIGlmIChwLnJpZ2h0KSBhcnIgPSBhcnIuY29uY2F0KHRvQXJyYXlfKHAucmlnaHQpKTtcbiAgcmV0dXJuIGFycjtcbn1cblxuXG52YXIgQVZMVHJlZSA9IGZ1bmN0aW9uKGNvbXBhcmVyKSB7XG4gIGlmICghY29tcGFyZXIpIGNvbXBhcmVyID0gY29tcGFyZXJfO1xuICB2YXIgQVZMID0ge1xuICAgIHJvb3Q6IG51bGwsXG4gICAgY29tcGFyZXJfOiBjb21wYXJlcixcblxuICAgIHNpemU6IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHdlaWdodF8oQVZMLnJvb3QpO1xuICAgIH0sXG5cbiAgICBtaW46IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHAgPSBnZXRNaW5pbXVtXyhBVkwucm9vdCk7XG4gICAgICBpZiAocCkgcmV0dXJuIHAua2V5O1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSxcblxuICAgIG1heDogZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgcCA9IGdldE1heGltdW1fKEFWTC5yb290KTtcbiAgICAgIGlmIChwKSByZXR1cm4gcC5rZXk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9LFxuXG4gICAgbG93ZXJCb3VuZDogZnVuY3Rpb24oaykge1xuICAgICAgcmV0dXJuIEFWTC5sb3dlckJvdW5kXyhBVkwucm9vdCwgayk7XG4gICAgfSxcbiAgICBsb3dlckJvdW5kXyhwLCBrKSB7XG4gICAgICBpZiAoIXApIHJldHVybiAwO1xuICAgICAgdmFyIGNtcCA9IEFWTC5jb21wYXJlcl8oaywgcC5rZXkpO1xuXG4gICAgICBpZiAoY21wIDw9IDApIHJldHVybiBBVkwubG93ZXJCb3VuZF8ocC5sZWZ0LCBrKTtcbiAgICAgIGVsc2UgaWYgKGNtcCA+IDApIHJldHVybiB3ZWlnaHRfKHAubGVmdCkgKyBBVkwubG93ZXJCb3VuZF8ocC5yaWdodCwgaykgKyAxO1xuICAgIH0sXG5cbiAgICB1cHBlckJvdW5kOiBmdW5jdGlvbihrKSB7XG4gICAgICByZXR1cm4gQVZMLnVwcGVyQm91bmRfKEFWTC5yb290LCBrKTtcbiAgICB9LFxuXG4gICAgdXBwZXJCb3VuZF8ocCwgaykge1xuICAgICAgaWYgKCFwKSByZXR1cm4gMDtcbiAgICAgIHZhciBjbXAgPSBBVkwuY29tcGFyZXJfKGssIHAua2V5KTtcblxuICAgICAgaWYgKGNtcCA8IDApIHJldHVybiBBVkwudXBwZXJCb3VuZF8ocC5sZWZ0LCBrKTtcbiAgICAgIGVsc2UgaWYgKGNtcCA+PSAwKSByZXR1cm4gd2VpZ2h0XyhwLmxlZnQpICsgQVZMLnVwcGVyQm91bmRfKHAucmlnaHQsIGspICsgMTtcbiAgICB9LFxuXG4gICAgY291bnQ6IGZ1bmN0aW9uKGspIHtcbiAgICAgIHJldHVybiBjb3VudF8oQVZMLnJvb3QsIGspO1xuICAgIH0sXG5cbiAgICBhdDogZnVuY3Rpb24oaykge1xuICAgICAgcmV0dXJuIGF0XyhBVkwucm9vdCwgayk7XG4gICAgfSxcblxuICAgIGluc2VydDogZnVuY3Rpb24oaykge1xuICAgICAgQVZMLnJvb3QgPSBBVkwuaW5zZXJ0XyhBVkwucm9vdCwgayk7XG4gICAgfSxcblxuICAgIGluc2VydF8ocCwgaykge1xuICAgICAgaWYgKCFwKSByZXR1cm4gY3JlYXRlTmV3Tm9kZV8oayk7XG4gICAgICB2YXIgY21wID0gQVZMLmNvbXBhcmVyXyhrLCBwLmtleSk7XG5cbiAgICAgIGlmIChjbXAgPCAwKSBwLmxlZnQgPSBBVkwuaW5zZXJ0XyhwLmxlZnQsIGspO1xuICAgICAgZWxzZSBpZiAoY21wID49IDApIHAucmlnaHQgPSBBVkwuaW5zZXJ0XyhwLnJpZ2h0LCBrKTtcbiAgICAgIHJldHVybiBiYWxhbmNlXyhwKTtcbiAgICB9LFxuXG4gICAgcmVtb3ZlOiBmdW5jdGlvbihrKSB7XG4gICAgICBBVkwucm9vdCA9IEFWTC5yZW1vdmVfKEFWTC5yb290LCBrKTtcbiAgICB9LFxuXG4gICAgcmVtb3ZlXyhwLCBrKSB7XG4gICAgICBpZiAoIXApIHJldHVybiBudWxsO1xuICAgICAgdmFyIGNtcCA9IEFWTC5jb21wYXJlcl8oaywgcC5rZXkpO1xuXG4gICAgICBpZiAoY21wIDwgMCkgcC5sZWZ0ID0gQVZMLnJlbW92ZV8ocC5sZWZ0LCBrKTtcbiAgICAgIGVsc2UgaWYgKGNtcCA+IDApIHAucmlnaHQgPSBBVkwucmVtb3ZlXyhwLnJpZ2h0LCBrKTtcbiAgICAgIGVsc2Uge1xuICAgICAgICB2YXIgcSA9IHAubGVmdDtcbiAgICAgICAgdmFyIHIgPSBwLnJpZ2h0O1xuICAgICAgICBpZiAoIXIpIHJldHVybiBxO1xuXG4gICAgICAgIHZhciBtaW4gPSBnZXRNaW5pbXVtXyhyKTtcbiAgICAgICAgbWluLnJpZ2h0ID0gcmVtb3ZlTWluaW11bl8ocik7XG4gICAgICAgIG1pbi5sZWZ0ID0gcTtcbiAgICAgICAgcmV0dXJuIGJhbGFuY2VfKG1pbik7XG4gICAgICB9XG4gICAgICByZXR1cm4gYmFsYW5jZV8ocCk7XG4gICAgfSxcblxuICAgIHJlbW92ZUF0OiBmdW5jdGlvbihrKSB7XG4gICAgICB2YXIgdmFsID0gQVZMLmF0KGspO1xuICAgICAgQVZMLnJvb3QgPSBBVkwucmVtb3ZlXyhBVkwucm9vdCwgdmFsKTtcbiAgICB9LFxuXG4gICAgdG9BcnJheTogZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoQVZMLnJvb3QgPT09IG51bGwpIHJldHVybiBbXTtcbiAgICAgIHJldHVybiB0b0FycmF5XyhBVkwucm9vdCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBBVkw7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQVZMVHJlZTtcbiJdfQ==