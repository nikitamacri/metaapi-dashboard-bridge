'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _index = require('../index');

var _index2 = _interopRequireDefault(_index);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

require('dotenv').config();
const token = process.env.TOKEN;
let login = process.env.LOGIN_MT4;
let password = process.env.PASSWORD_MT4;
let serverName = process.env.SERVER_MT4 || 'Tradeview-Demo';
let brokerSrvFile = process.env.PATH_TO_BROKER_SRV || './lib/integration-tests/files/tradeview-demo.broker.srv';
const api = new _index2.default(token, { application: 'MetaApi', domain: 'project-stock.v3.agiliumlabs.cloud' });

describe('MT4 sync positions test', () => {

  async function checkPositions(connection) {
    return { local: connection.terminalState.positions.length, real: (await connection.getPositions()).length };
  }

  // eslint-disable-next-line max-statements
  it('should show correct positions amount after opening and closing', async function () {
    if (token && login) {
      const profiles = await api.provisioningProfileApi.getProvisioningProfiles();
      this.timeout(600000);
      let profile = profiles.find(p => p.name === serverName);
      if (!profile) {
        profile = await api.provisioningProfileApi.createProvisioningProfile({
          name: serverName,
          version: 4,
          brokerTimezone: 'EET',
          brokerDSTSwitchTimezone: 'EET'
        });
        await profile.uploadFile('broker.srv', brokerSrvFile);
      }
      if (profile && profile.status === 'new') {
        await profile.uploadFile('broker.srv', brokerSrvFile);
      }
      let accounts = await api.metatraderAccountApi.getAccounts();
      let account = accounts.find(a => a.login === login && a.type === 'cloud-g2');
      if (!account) {
        account = await api.metatraderAccountApi.createAccount({
          name: 'Test account-mt4',
          type: 'cloud-g2',
          login: login,
          password: password,
          server: serverName,
          provisioningProfileId: profile.id,
          application: 'MetaApi',
          magic: 1000
        });
      }
      await account.deploy();
      await account.waitConnected();
      let connection = await account.connect();
      await connection.waitSynchronized({ timeoutInSeconds: 600 });
      const startPositions = connection.terminalState.positions.length;
      const positionIds = [];
      for (let i = 0; i < 10; i++) {
        let result = await connection.createMarketBuyOrder('GBPUSD', 0.01, 0.9, 2.0);
        positionIds.push(result.positionId);
        await new _promise2.default(res => setTimeout(res, 200));
      }
      await new _promise2.default(res => setTimeout(res, 200));
      let positions = await checkPositions(connection);
      _sinon2.default.assert.match(positions.local, startPositions + 10);
      _sinon2.default.assert.match(positions.real, startPositions + 10);
      await new _promise2.default(res => setTimeout(res, 5000));
      await _promise2.default.all(positionIds.map(async id => {
        await connection.closePosition(id);
      }));
      await new _promise2.default(res => setTimeout(res, 1000));
      await _promise2.default.all(positionIds.map(async id => {
        try {
          await connection.getPosition(id);
          _sinon2.default.assert.fail();
        } catch (err) {//eslint-ignore-line
        }
      }));
      positions = await checkPositions(connection);
      _sinon2.default.assert.match(positions.local, startPositions);
      _sinon2.default.assert.match(positions.real, startPositions);
      await account.undeploy();
    }
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9pbnRlZ3JhdGlvbi10ZXN0cy9zeW5jUG9zaXRpb25zLnNwZWMuZXM2Il0sIm5hbWVzIjpbInJlcXVpcmUiLCJjb25maWciLCJ0b2tlbiIsInByb2Nlc3MiLCJlbnYiLCJUT0tFTiIsImxvZ2luIiwiTE9HSU5fTVQ0IiwicGFzc3dvcmQiLCJQQVNTV09SRF9NVDQiLCJzZXJ2ZXJOYW1lIiwiU0VSVkVSX01UNCIsImJyb2tlclNydkZpbGUiLCJQQVRIX1RPX0JST0tFUl9TUlYiLCJhcGkiLCJNZXRhQVBJIiwiYXBwbGljYXRpb24iLCJkb21haW4iLCJkZXNjcmliZSIsImNoZWNrUG9zaXRpb25zIiwiY29ubmVjdGlvbiIsImxvY2FsIiwidGVybWluYWxTdGF0ZSIsInBvc2l0aW9ucyIsImxlbmd0aCIsInJlYWwiLCJnZXRQb3NpdGlvbnMiLCJpdCIsInByb2ZpbGVzIiwicHJvdmlzaW9uaW5nUHJvZmlsZUFwaSIsImdldFByb3Zpc2lvbmluZ1Byb2ZpbGVzIiwidGltZW91dCIsInByb2ZpbGUiLCJmaW5kIiwicCIsIm5hbWUiLCJjcmVhdGVQcm92aXNpb25pbmdQcm9maWxlIiwidmVyc2lvbiIsImJyb2tlclRpbWV6b25lIiwiYnJva2VyRFNUU3dpdGNoVGltZXpvbmUiLCJ1cGxvYWRGaWxlIiwic3RhdHVzIiwiYWNjb3VudHMiLCJtZXRhdHJhZGVyQWNjb3VudEFwaSIsImdldEFjY291bnRzIiwiYWNjb3VudCIsImEiLCJ0eXBlIiwiY3JlYXRlQWNjb3VudCIsInNlcnZlciIsInByb3Zpc2lvbmluZ1Byb2ZpbGVJZCIsImlkIiwibWFnaWMiLCJkZXBsb3kiLCJ3YWl0Q29ubmVjdGVkIiwiY29ubmVjdCIsIndhaXRTeW5jaHJvbml6ZWQiLCJ0aW1lb3V0SW5TZWNvbmRzIiwic3RhcnRQb3NpdGlvbnMiLCJwb3NpdGlvbklkcyIsImkiLCJyZXN1bHQiLCJjcmVhdGVNYXJrZXRCdXlPcmRlciIsInB1c2giLCJwb3NpdGlvbklkIiwicmVzIiwic2V0VGltZW91dCIsInNpbm9uIiwiYXNzZXJ0IiwibWF0Y2giLCJhbGwiLCJtYXAiLCJjbG9zZVBvc2l0aW9uIiwiZ2V0UG9zaXRpb24iLCJmYWlsIiwiZXJyIiwidW5kZXBsb3kiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7OztBQUNBQSxRQUFRLFFBQVIsRUFBa0JDLE1BQWxCO0FBQ0EsTUFBTUMsUUFBUUMsUUFBUUMsR0FBUixDQUFZQyxLQUExQjtBQUNBLElBQUlDLFFBQVFILFFBQVFDLEdBQVIsQ0FBWUcsU0FBeEI7QUFDQSxJQUFJQyxXQUFXTCxRQUFRQyxHQUFSLENBQVlLLFlBQTNCO0FBQ0EsSUFBSUMsYUFBYVAsUUFBUUMsR0FBUixDQUFZTyxVQUFaLElBQTBCLGdCQUEzQztBQUNBLElBQUlDLGdCQUFnQlQsUUFBUUMsR0FBUixDQUFZUyxrQkFBWixJQUFrQyx5REFBdEQ7QUFDQSxNQUFNQyxNQUFNLElBQUlDLGVBQUosQ0FBWWIsS0FBWixFQUFtQixFQUFDYyxhQUFhLFNBQWQsRUFBeUJDLFFBQVEsb0NBQWpDLEVBQW5CLENBQVo7O0FBRUFDLFNBQVMseUJBQVQsRUFBb0MsTUFBTTs7QUFFeEMsaUJBQWVDLGNBQWYsQ0FBOEJDLFVBQTlCLEVBQTBDO0FBQ3hDLFdBQU8sRUFBQ0MsT0FBT0QsV0FBV0UsYUFBWCxDQUF5QkMsU0FBekIsQ0FBbUNDLE1BQTNDLEVBQW1EQyxNQUFNLENBQUMsTUFBTUwsV0FBV00sWUFBWCxFQUFQLEVBQWtDRixNQUEzRixFQUFQO0FBQ0Q7O0FBRUQ7QUFDQUcsS0FBRyxnRUFBSCxFQUFxRSxrQkFBaUI7QUFDcEYsUUFBR3pCLFNBQVNJLEtBQVosRUFBbUI7QUFDakIsWUFBTXNCLFdBQVcsTUFBTWQsSUFBSWUsc0JBQUosQ0FBMkJDLHVCQUEzQixFQUF2QjtBQUNBLFdBQUtDLE9BQUwsQ0FBYSxNQUFiO0FBQ0EsVUFBSUMsVUFBVUosU0FBU0ssSUFBVCxDQUFjQyxLQUFLQSxFQUFFQyxJQUFGLEtBQVd6QixVQUE5QixDQUFkO0FBQ0EsVUFB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LFdBQVdxRCxXQUFYLENBQXVCdEIsRUFBdkIsQ0FBTjtBQUNBZ0IsMEJBQU1DLE1BQU4sQ0FBYU0sSUFBYjtBQUNELFNBSEQsQ0FHRSxPQUFNQyxHQUFOLEVBQVcsQ0FBRTtBQUNkO0FBQ0YsT0FOaUIsQ0FBWixDQUFOO0FBT0FwRCxrQkFBWSxNQUFNSixlQUFlQyxVQUFmLENBQWxCO0FBQ0ErQyxzQkFBTUMsTUFBTixDQUFhQyxLQUFiLENBQW1COUMsVUFBVUYsS0FBN0IsRUFBb0NxQyxjQUFwQztBQUNBUyxzQkFBTUMsTUFBTixDQUFhQyxLQUFiLENBQW1COUMsVUFBVUUsSUFBN0IsRUFBbUNpQyxjQUFuQztBQUNBLFlBQU1iLFFBQVErQixRQUFSLEVBQU47QUFDRDtBQUNGLEdBL0REO0FBZ0VELENBdkVEIiwiZmlsZSI6InN5bmNQb3NpdGlvbnMuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNZXRhQVBJIGZyb20gJy4uL2luZGV4JztcbmltcG9ydCBzaW5vbiBmcm9tICdzaW5vbic7XG5yZXF1aXJlKCdkb3RlbnYnKS5jb25maWcoKTtcbmNvbnN0IHRva2VuID0gcHJvY2Vzcy5lbnYuVE9LRU47XG5sZXQgbG9naW4gPSBwcm9jZXNzLmVudi5MT0dJTl9NVDQ7XG5sZXQgcGFzc3dvcmQgPSBwcm9jZXNzLmVudi5QQVNTV09SRF9NVDQ7XG5sZXQgc2VydmVyTmFtZSA9IHByb2Nlc3MuZW52LlNFUlZFUl9NVDQgfHwgJ1RyYWRldmlldy1EZW1vJztcbmxldCBicm9rZXJTcnZGaWxlID0gcHJvY2Vzcy5lbnYuUEFUSF9UT19CUk9LRVJfU1JWIHx8ICcuL2xpYi9pbnRlZ3JhdGlvbi10ZXN0cy9maWxlcy90cmFkZXZpZXctZGVtby5icm9rZXIuc3J2JztcbmNvbnN0IGFwaSA9IG5ldyBNZXRhQVBJKHRva2VuLCB7YXBwbGljYXRpb246ICdNZXRhQXBpJywgZG9tYWluOiAncHJvamVjdC1zdG9jay52My5hZ2lsaXVtbGFicy5jbG91ZCd9KTtcblxuZGVzY3JpYmUoJ01UNCBzeW5jIHBvc2l0aW9ucyB0ZXN0JywgKCkgPT4ge1xuXG4gIGFzeW5jIGZ1bmN0aW9uIGNoZWNrUG9zaXRpb25zKGNvbm5lY3Rpb24pIHtcbiAgICByZXR1cm4ge2xvY2FsOiBjb25uZWN0aW9uLnRlcm1pbmFsU3RhdGUucG9zaXRpb25zLmxlbmd0aCwgcmVhbDogKGF3YWl0IGNvbm5lY3Rpb24uZ2V0UG9zaXRpb25zKCkpLmxlbmd0aH07XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LXN0YXRlbWVudHNcbiAgaXQoJ3Nob3VsZCBzaG93IGNvcnJlY3QgcG9zaXRpb25zIGFtb3VudCBhZnRlciBvcGVuaW5nIGFuZCBjbG9zaW5nJywgYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgaWYodG9rZW4gJiYgbG9naW4pIHtcbiAgICAgIGNvbnN0IHByb2ZpbGVzID0gYXdhaXQgYXBpLnByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkuZ2V0UHJvdmlzaW9uaW5nUHJvZmlsZXMoKTtcbiAgICAgIHRoaXMudGltZW91dCg2MDAwMDApO1xuICAgICAgbGV0IHByb2ZpbGUgPSBwcm9maWxlcy5maW5kKHAgPT4gcC5uYW1lID09PSBzZXJ2ZXJOYW1lKTtcbiAgICAgIGlmICghcHJvZmlsZSkge1xuICAgICAgICBwcm9maWxlID0gYXdhaXQgYXBpLnByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkuY3JlYXRlUHJvdmlzaW9uaW5nUHJvZmlsZSh7XG4gICAgICAgICAgbmFtZTogc2VydmVyTmFtZSxcbiAgICAgICAgICB2ZXJzaW9uOiA0LFxuICAgICAgICAgIGJyb2tlclRpbWV6b25lOiAnRUVUJyxcbiAgICAgICAgICBicm9rZXJEU1RTd2l0Y2hUaW1lem9uZTogJ0VFVCdcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHByb2ZpbGUudXBsb2FkRmlsZSgnYnJva2VyLnNydicsIGJyb2tlclNydkZpbGUpO1xuICAgICAgfVxuICAgICAgaWYgKHByb2ZpbGUgJiYgcHJvZmlsZS5zdGF0dXMgPT09ICduZXcnKSB7XG4gICAgICAgIGF3YWl0IHByb2ZpbGUudXBsb2FkRmlsZSgnYnJva2VyLnNydicsIGJyb2tlclNydkZpbGUpO1xuICAgICAgfVxuICAgICAgbGV0IGFjY291bnRzID0gYXdhaXQgYXBpLm1ldGF0cmFkZXJBY2NvdW50QXBpLmdldEFjY291bnRzKCk7XG4gICAgICBsZXQgYWNjb3VudCA9IGFjY291bnRzLmZpbmQoYSA9PiBhLmxvZ2luID09PSBsb2dpbiAmJiBhLnR5cGUgPT09ICdjbG91ZC1nMicpO1xuICAgICAgaWYgKCFhY2NvdW50KSB7XG4gICAgICAgIGFjY291bnQgPSBhd2FpdCBhcGkubWV0YXRyYWRlckFjY291bnRBcGkuY3JlYXRlQWNjb3VudCh7XG4gICAgICAgICAgbmFtZTogJ1Rlc3QgYWNjb3VudC1tdDQnLFxuICAgICAgICAgIHR5cGU6ICdjbG91ZC1nMicsXG4gICAgICAgICAgbG9naW46IGxvZ2luLFxuICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZCxcbiAgICAgICAgICBzZXJ2ZXI6IHNlcnZlck5hbWUsXG4gICAgICAgICAgcHJvdmlzaW9uaW5nUHJvZmlsZUlkOiBwcm9maWxlLmlkLFxuICAgICAgICAgIGFwcGxpY2F0aW9uOiAnTWV0YUFwaScsXG4gICAgICAgICAgbWFnaWM6IDEwMDBcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBhd2FpdCBhY2NvdW50LmRlcGxveSgpO1xuICAgICAgYXdhaXQgYWNjb3VudC53YWl0Q29ubmVjdGVkKCk7XG4gICAgICBsZXQgY29ubmVjdGlvbiA9IGF3YWl0IGFjY291bnQuY29ubmVjdCgpO1xuICAgICAgYXdhaXQgY29ubmVjdGlvbi53YWl0U3luY2hyb25pemVkKHt0aW1lb3V0SW5TZWNvbmRzOiA2MDB9KTsgXG4gICAgICBjb25zdCBzdGFydFBvc2l0aW9ucyA9IGNvbm5lY3Rpb24udGVybWluYWxTdGF0ZS5wb3NpdGlvbnMubGVuZ3RoO1xuICAgICAgY29uc3QgcG9zaXRpb25JZHMgPSBbXTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTA7IGkrKykge1xuICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5jcmVhdGVNYXJrZXRCdXlPcmRlcignR0JQVVNEJywgMC4wMSwgMC45LCAyLjApOyBcbiAgICAgICAgcG9zaXRpb25JZHMucHVzaChyZXN1bHQucG9zaXRpb25JZCk7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgMjAwKSk7XG4gICAgICB9XG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDIwMCkpO1xuICAgICAgbGV0IHBvc2l0aW9ucyA9IGF3YWl0IGNoZWNrUG9zaXRpb25zKGNvbm5lY3Rpb24pO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKHBvc2l0aW9ucy5sb2NhbCwgc3RhcnRQb3NpdGlvbnMgKyAxMCk7XG4gICAgICBzaW5vbi5hc3NlcnQubWF0Y2gocG9zaXRpb25zLnJlYWwsIHN0YXJ0UG9zaXRpb25zICsgMTApO1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCA1MDAwKSk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChwb3NpdGlvbklkcy5tYXAoYXN5bmMgaWQgPT4ge1xuICAgICAgICBhd2FpdCBjb25uZWN0aW9uLmNsb3NlUG9zaXRpb24oaWQpO1xuICAgICAgfSkpO1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCAxMDAwKSk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChwb3NpdGlvbklkcy5tYXAoYXN5bmMgaWQgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UG9zaXRpb24oaWQpO1xuICAgICAgICAgIHNpbm9uLmFzc2VydC5mYWlsKCk7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7IC8vZXNsaW50LWlnbm9yZS1saW5lXG4gICAgICAgIH1cbiAgICAgIH0pKTtcbiAgICAgIHBvc2l0aW9ucyA9IGF3YWl0IGNoZWNrUG9zaXRpb25zKGNvbm5lY3Rpb24pO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKHBvc2l0aW9ucy5sb2NhbCwgc3RhcnRQb3NpdGlvbnMpO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKHBvc2l0aW9ucy5yZWFsLCBzdGFydFBvc2l0aW9ucyk7XG4gICAgICBhd2FpdCBhY2NvdW50LnVuZGVwbG95KCk7XG4gICAgfVxuICB9KTtcbn0pO1xuIl19