'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _index = require('../index');

var _index2 = _interopRequireDefault(_index);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

require('dotenv').config();
const token = process.env.TOKEN;
let login = process.env.LOGIN;
let password = process.env.PASSWORD;
let serverName = process.env.SERVER;
let serverDatFile = process.env.PATH_TO_SERVERS_DAT;
const api = new _index2.default(token, { application: 'MetaApi', domain: 'project-stock.v3.agiliumlabs.cloud' });

describe('MT5 double synchronization test', () => {

  before(async () => {
    await _fsExtra2.default.ensureDir('./.metaapi');
  });

  afterEach(async () => {
    await _fsExtra2.default.emptyDir('./.metaapi');
  });

  it('should not corrupt files after simultaneous synchronization', async function () {
    if (token) {
      const profiles = await api.provisioningProfileApi.getProvisioningProfiles();
      this.timeout(600000);
      let profile = profiles.find(p => p.name === serverName);
      if (!profile) {
        profile = await api.provisioningProfileApi.createProvisioningProfile({
          name: serverName,
          version: 5
        });
        await profile.uploadFile('servers.dat', serverDatFile);
      }
      if (profile && profile.status === 'new') {
        await profile.uploadFile('servers.dat', serverDatFile);
      }
      let accounts = await api.metatraderAccountApi.getAccounts();
      let account = accounts.find(a => a.login === login && a.type.startsWith('cloud'));
      if (!account) {
        account = await api.metatraderAccountApi.createAccount({
          name: 'Test account',
          type: 'cloud',
          login: login,
          password: password,
          server: serverName,
          provisioningProfileId: profile.id,
          application: 'MetaApi',
          magic: 1000
        });
      }
      let accountCopy = await api.metatraderAccountApi.getAccount(account.id);
      await _promise2.default.all([account.deploy(), accountCopy.deploy()]);
      await _promise2.default.all([account.waitConnected(), accountCopy.waitConnected()]);
      let connection = await account.connect();
      let connectionCopy = await accountCopy.connect();
      await _promise2.default.all([connection.waitSynchronized({ timeoutInSeconds: 600 }), connectionCopy.waitSynchronized({ timeoutInSeconds: 600 })]);
      await account.undeploy();
      await accountCopy.undeploy();
      api._metaApiWebsocketClient.removeAllListeners();
      JSON.parse((await _fsExtra2.default.readFile(`./.metaapi/${account.id}-MetaApi-deals.bin`)));
      JSON.parse((await _fsExtra2.default.readFile(`./.metaapi/${account.id}-MetaApi-historyOrders.bin`)));
    }
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9pbnRlZ3JhdGlvbi10ZXN0cy9kb3VibGVTeW5jaHJvbml6YXRpb25UZXN0LnNwZWMuZXM2Il0sIm5hbWVzIjpbInJlcXVpcmUiLCJjb25maWciLCJ0b2tlbiIsInByb2Nlc3MiLCJlbnYiLCJUT0tFTiIsImxvZ2luIiwiTE9HSU4iLCJwYXNzd29yZCIsIlBBU1NXT1JEIiwic2VydmVyTmFtZSIsIlNFUlZFUiIsInNlcnZlckRhdEZpbGUiLCJQQVRIX1RPX1NFUlZFUlNfREFUIiwiYXBpIiwiTWV0YUFQSSIsImFwcGxpY2F0aW9uIiwiZG9tYWluIiwiZGVzY3JpYmUiLCJiZWZvcmUiLCJmcyIsImVuc3VyZURpciIsImFmdGVyRWFjaCIsImVtcHR5RGlyIiwiaXQiLCJwcm9maWxlcyIsInByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkiLCJnZXRQcm92aXNpb25pbmdQcm9maWxlcyIsInRpbWVvdXQiLCJwcm9maWxlIiwiZmluZCIsInAiLCJuYW1lIiwiY3JlYXRlUHJvdmlzaW9uaW5nUHJvZmlsZSIsInZlcnNpb24iLCJ1cGxvYWRGaWxlIiwic3RhdHVzIiwiYWNjb3VudHMiLCJtZXRhdHJhZGVyQWNjb3VudEFwaSIsImdldEFjY291bnRzIiwiYWNjb3VudCIsImEiLCJ0eXBlIiwic3RhcnRzV2l0aCIsImNyZWF0ZUFjY291bnQiLCJzZXJ2ZXIiLCJwcm92aXNpb25pbmdQcm9maWxlSWQiLCJpZCIsIm1hZ2ljIiwiYWNjb3VudENvcHkiLCJnZXRBY2NvdW50IiwiYWxsIiwiZGVwbG95Iiwid2FpdENvbm5lY3RlZCIsImNvbm5lY3Rpb24iLCJjb25uZWN0IiwiY29ubmVjdGlvbkNvcHkiLCJ3YWl0U3luY2hyb25pemVkIiwidGltZW91dEluU2Vjb25kcyIsInVuZGVwbG95IiwiX21ldGFBcGlXZWJzb2NrZXRDbGllbnQiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7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WCxDQUE0QixFQUFDQyxrQkFBa0IsR0FBbkIsRUFBNUIsQ0FEZ0IsRUFFaEJGLGVBQWVDLGdCQUFmLENBQWdDLEVBQUNDLGtCQUFrQixHQUFuQixFQUFoQyxDQUZnQixDQUFaLENBQU47QUFJQSxZQUFNbEIsUUFBUW1CLFFBQVIsRUFBTjtBQUNBLFlBQU1WLFlBQVlVLFFBQVosRUFBTjtBQUNBN0MsVUFBSThDLHVCQUFKLENBQTRCQyxrQkFBNUI7QUFDQUMsV0FBS0MsS0FBTCxFQUFXLE1BQU0zQyxrQkFBRzRDLFFBQUgsQ0FBYSxjQUFheEIsUUFBUU8sRUFBRyxvQkFBckMsQ0FBakI7QUFDQWUsV0FBS0MsS0FBTCxFQUFXLE1BQU0zQyxrQkFBRzRDLFFBQUgsQ0FBYSxjQUFheEIsUUFBUU8sRUFBRyw0QkFBckMsQ0FBakI7QUFDRDtBQUNGLEdBbEREO0FBbURELENBN0REIiwiZmlsZSI6ImRvdWJsZVN5bmNocm9uaXphdGlvblRlc3Quc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNZXRhQVBJIGZyb20gJy4uL2luZGV4JztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5yZXF1aXJlKCdkb3RlbnYnKS5jb25maWcoKTtcbmNvbnN0IHRva2VuID0gcHJvY2Vzcy5lbnYuVE9LRU47XG5sZXQgbG9naW4gPSBwcm9jZXNzLmVudi5MT0dJTjtcbmxldCBwYXNzd29yZCA9IHByb2Nlc3MuZW52LlBBU1NXT1JEO1xubGV0IHNlcnZlck5hbWUgPSBwcm9jZXNzLmVudi5TRVJWRVI7XG5sZXQgc2VydmVyRGF0RmlsZSA9IHByb2Nlc3MuZW52LlBBVEhfVE9fU0VSVkVSU19EQVQ7XG5jb25zdCBhcGkgPSBuZXcgTWV0YUFQSSh0b2tlbiwge2FwcGxpY2F0aW9uOiAnTWV0YUFwaScsIGRvbWFpbjogJ3Byb2plY3Qtc3RvY2sudjMuYWdpbGl1bWxhYnMuY2xvdWQnfSk7XG5cbmRlc2NyaWJlKCdNVDUgZG91YmxlIHN5bmNocm9uaXphdGlvbiB0ZXN0JywgKCkgPT4ge1xuXG4gIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKCcuLy5tZXRhYXBpJyk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZnMuZW1wdHlEaXIoJy4vLm1ldGFhcGknKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBub3QgY29ycnVwdCBmaWxlcyBhZnRlciBzaW11bHRhbmVvdXMgc3luY2hyb25pemF0aW9uJywgYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgaWYodG9rZW4pIHtcbiAgICAgIGNvbnN0IHByb2ZpbGVzID0gYXdhaXQgYXBpLnByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkuZ2V0UHJvdmlzaW9uaW5nUHJvZmlsZXMoKTtcbiAgICAgIHRoaXMudGltZW91dCg2MDAwMDApO1xuICAgICAgbGV0IHByb2ZpbGUgPSBwcm9maWxlcy5maW5kKHAgPT4gcC5uYW1lID09PSBzZXJ2ZXJOYW1lKTtcbiAgICAgIGlmICghcHJvZmlsZSkge1xuICAgICAgICBwcm9maWxlID0gYXdhaXQgYXBpLnByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkuY3JlYXRlUHJvdmlzaW9uaW5nUHJvZmlsZSh7XG4gICAgICAgICAgbmFtZTogc2VydmVyTmFtZSxcbiAgICAgICAgICB2ZXJzaW9uOiA1XG4gICAgICAgIH0pO1xuICAgICAgICBhd2FpdCBwcm9maWxlLnVwbG9hZEZpbGUoJ3NlcnZlcnMuZGF0Jywgc2VydmVyRGF0RmlsZSk7XG4gICAgICB9XG4gICAgICBpZiAocHJvZmlsZSAmJiBwcm9maWxlLnN0YXR1cyA9PT0gJ25ldycpIHtcbiAgICAgICAgYXdhaXQgcHJvZmlsZS51cGxvYWRGaWxlKCdzZXJ2ZXJzLmRhdCcsIHNlcnZlckRhdEZpbGUpO1xuICAgICAgfVxuICAgICAgbGV0IGFjY291bnRzID0gYXdhaXQgYXBpLm1ldGF0cmFkZXJBY2NvdW50QXBpLmdldEFjY291bnRzKCk7XG4gICAgICBsZXQgYWNjb3VudCA9IGFjY291bnRzLmZpbmQoYSA9PiBhLmxvZ2luID09PSBsb2dpbiAmJiBhLnR5cGUuc3RhcnRzV2l0aCgnY2xvdWQnKSk7XG4gICAgICBpZiAoIWFjY291bnQpIHtcbiAgICAgICAgYWNjb3VudCA9IGF3YWl0IGFwaS5tZXRhdHJhZGVyQWNjb3VudEFwaS5jcmVhdGVBY2NvdW50KHtcbiAgICAgICAgICBuYW1lOiAnVGVzdCBhY2NvdW50JyxcbiAgICAgICAgICB0eXBlOiAnY2xvdWQnLFxuICAgICAgICAgIGxvZ2luOiBsb2dpbixcbiAgICAgICAgICBwYXNzd29yZDogcGFzc3dvcmQsXG4gICAgICAgICAgc2VydmVyOiBzZXJ2ZXJOYW1lLFxuICAgICAgICAgIHByb3Zpc2lvbmluZ1Byb2ZpbGVJZDogcHJvZmlsZS5pZCxcbiAgICAgICAgICBhcHBsaWNhdGlvbjogJ01ldGFBcGknLFxuICAgICAgICAgIG1hZ2ljOiAxMDAwXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgbGV0IGFjY291bnRDb3B5ID0gYXdhaXQgYXBpLm1ldGF0cmFkZXJBY2NvdW50QXBpLmdldEFjY291bnQoYWNjb3VudC5pZCk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIGFjY291bnQuZGVwbG95KCksXG4gICAgICAgIGFjY291bnRDb3B5LmRlcGxveSgpXG4gICAgICBdKTtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgYWNjb3VudC53YWl0Q29ubmVjdGVkKCksXG4gICAgICAgIGFjY291bnRDb3B5LndhaXRDb25uZWN0ZWQoKVxuICAgICAgXSk7XG4gICAgICBsZXQgY29ubmVjdGlvbiA9IGF3YWl0IGFjY291bnQuY29ubmVjdCgpO1xuICAgICAgbGV0IGNvbm5lY3Rpb25Db3B5ID0gYXdhaXQgYWNjb3VudENvcHkuY29ubmVjdCgpO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICBjb25uZWN0aW9uLndhaXRTeW5jaHJvbml6ZWQoe3RpbWVvdXRJblNlY29uZHM6IDYwMH0pLFxuICAgICAgICBjb25uZWN0aW9uQ29weS53YWl0U3luY2hyb25pemVkKHt0aW1lb3V0SW5TZWNvbmRzOiA2MDB9KVxuICAgICAgXSk7XG4gICAgICBhd2FpdCBhY2NvdW50LnVuZGVwbG95KCk7XG4gICAgICBhd2FpdCBhY2NvdW50Q29weS51bmRlcGxveSgpO1xuICAgICAgYXBpLl9tZXRhQXBpV2Vic29ja2V0Q2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygpO1xuICAgICAgSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZShgLi8ubWV0YWFwaS8ke2FjY291bnQuaWR9LU1ldGFBcGktZGVhbHMuYmluYCkpO1xuICAgICAgSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZShgLi8ubWV0YWFwaS8ke2FjY291bnQuaWR9LU1ldGFBcGktaGlzdG9yeU9yZGVycy5iaW5gKSk7XG4gICAgfVxuICB9KTtcbn0pO1xuIl19